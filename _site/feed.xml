<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="https://www.w3.org/2005/Atom">
	<channel>
		<title>Blog</title>
		<description>fromChinaBoy</description>
		<link>/</link>
		<atom:link href="/" rel="self" type="application/rss+xml" />
		
			<item>
				<title>SPU & SKU</title>
				<description>&lt;h2 id=&quot;æ¦‚å¿µ&quot;&gt;æ¦‚å¿µ&lt;/h2&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;åè¯&lt;/th&gt;
      &lt;th&gt;å…¨ç§°&lt;/th&gt;
      &lt;th&gt;æè¿°&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;SPU&lt;/td&gt;
      &lt;td&gt;Standard Product Unit  æ ‡å‡†åŒ–äº§å“å•å…ƒ&lt;/td&gt;
      &lt;td&gt;æ˜¯å•†å“ä¿¡æ¯èšåˆçš„æœ€å°å•ä½ï¼Œæ˜¯ä¸€ç»„å¯å¤ç”¨ã€æ˜“æ£€ç´¢çš„æ ‡å‡†åŒ–ä¿¡æ¯çš„é›†åˆï¼Œè¯¥é›†åˆæè¿°äº†ä¸€ä¸ªäº§å“çš„ç‰¹æ€§ã€‚é€šä¿—ç‚¹è®²ï¼Œå±æ€§å€¼ã€ç‰¹æ€§ç›¸åŒçš„å•†å“å°±å¯ä»¥ç§°ä¸ºä¸€ä¸ªSPUã€‚&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;SKU&lt;/td&gt;
      &lt;td&gt;Stock Keeping Unit åº“å­˜é‡å•ä½&lt;/td&gt;
      &lt;td&gt;å³åº“å­˜è¿›å‡ºè®¡é‡çš„å•ä½ï¼Œ å¯ä»¥æ˜¯ä»¥ä»¶ã€ç›’ã€æ‰˜ç›˜ç­‰ä¸ºå•ä½ã€‚SKUæ˜¯ç‰©ç†ä¸Šä¸å¯åˆ†å‰²çš„æœ€å°å­˜è´§å•å…ƒã€‚åœ¨ä½¿ç”¨æ—¶è¦æ ¹æ®ä¸åŒä¸šæ€ï¼Œä¸åŒç®¡ç†æ¨¡å¼æ¥å¤„ç†ã€‚&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;å¤§ç™½è¯&quot;&gt;å¤§ç™½è¯&lt;/h2&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;äº§å“å&lt;/th&gt;
      &lt;th&gt;åˆ†ç±»&lt;/th&gt;
      &lt;th&gt;SPU&lt;/th&gt;
      &lt;th&gt;SKU&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;Apple iPhone 11 (A2223) 128GB é»‘è‰² ç§»åŠ¨è”é€šç”µä¿¡4Gæ‰‹æœº åŒå¡åŒå¾…&lt;/td&gt;
      &lt;td&gt;æ‰‹æœº&lt;/td&gt;
      &lt;td&gt;iPhone 11 (A2223)&lt;/td&gt;
      &lt;td&gt;128GB é»‘è‰² ç§»åŠ¨è”é€šç”µä¿¡4Gæ‰‹æœº åŒå¡åŒå¾…&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;å¤–æ˜ŸäººAlienware m15 2020ç‰ˆ 15.6è‹±å¯¸è½»è–„æ¸¸æˆæœ¬(åä»£i7-10750H 16G 1TBSSD RTX2070 8Gç‹¬æ˜¾)ç™½&lt;/td&gt;
      &lt;td&gt;ç”µè„‘&lt;/td&gt;
      &lt;td&gt;å¤–æ˜ŸäººAlienware m15&lt;/td&gt;
      &lt;td&gt;15.6è‹±å¯¸è½»è–„æ¸¸æˆæœ¬(åä»£i7-10750H 16G 1TBSSD RTX2070 8Gç‹¬æ˜¾)ç™½&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;å®‰å¾·ç›å®˜æ–¹UA Spawn 2ç”·å­ç¯®çƒé‹Under Armour3022626 ç°è‰²106 46&lt;/td&gt;
      &lt;td&gt;ç¯®çƒé‹&lt;/td&gt;
      &lt;td&gt;å®‰å¾·ç›å®˜æ–¹UA Spawn 2ç”·å­ç¯®çƒé‹Under Armour3022626&lt;/td&gt;
      &lt;td&gt;ç°è‰²106 46&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;æ•°æ®æ¨¡å‹è®¾è®¡&quot;&gt;æ•°æ®æ¨¡å‹è®¾è®¡&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;SPUè¡¨&lt;/strong&gt;ä¸€èˆ¬ä¼šæœ‰ä¸¤ä¸ªä¸Šçº§ç›¸å…³å±æ€§è¡¨&lt;strong&gt;brandsè¡¨&lt;/strong&gt;å’Œ&lt;strong&gt;categoryè¡¨&lt;/strong&gt;ã€‚ä¸ºäº†æ–¹ä¾¿åˆ›å»º&lt;strong&gt;SKUè¡¨&lt;/strong&gt;æ•°æ®ï¼Œä¼šæœ‰å»¶ä¼¸å‡ºå¯å¤ç”¨çš„&lt;strong&gt;é”€å”®å±æ€§è¡¨&lt;/strong&gt;å’Œ&lt;strong&gt;é”€å”®å±æ€§å€¼è¡¨&lt;/strong&gt;ã€‚
é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬åº”è¯¥è¿˜æœ‰&lt;strong&gt;SKUåº“å­˜è¡¨&lt;/strong&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;è¡¨åç§°&lt;/th&gt;
      &lt;th&gt;è¡¨å&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;å“ç‰Œè¡¨&lt;/td&gt;
      &lt;td&gt;product_brands&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;ç±»åˆ«è¡¨&lt;/td&gt;
      &lt;td&gt;product_category&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;spuè¡¨&lt;/td&gt;
      &lt;td&gt;product_spu&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;skuè¡¨&lt;/td&gt;
      &lt;td&gt;product_sku&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;é”€å”®å±æ€§è¡¨&lt;/td&gt;
      &lt;td&gt;product_attr&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;é”€å”®å±æ€§å€¼&lt;/td&gt;
      &lt;td&gt;product_attr_value&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;skuåº“å­˜è¡¨&lt;/td&gt;
      &lt;td&gt;product_sku_stock&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;é™¤äº†ä¸Šé¢çš„è¡¨ä¹‹å¤–ï¼Œæˆ‘åˆåŠ äº†å¦ä¸€å¼ è¡¨ &lt;code class=&quot;highlighter-rouge&quot;&gt;å…³è”å…³ç³»å†—ä½™è¡¨ product_spu_sku_attr_map&lt;/code&gt;ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿé¡¾åæ€ä¹‰ï¼Œå†—ä½™ç”¨çš„ï¼Œæœ‰äº†è¿™å¼ è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆé«˜æ•ˆçš„å¾—åˆ°ï¼š&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;spuä¸‹ æœ‰å“ªäº›sku&lt;/li&gt;
  &lt;li&gt;spuä¸‹ æœ‰é‚£äº›é”€å”®å±æ€§&lt;/li&gt;
  &lt;li&gt;spuä¸‹ æ¯ä¸ªé”€å”®å±æ€§å¯¹åº”çš„é”€å”®å±æ€§å€¼(ä¸€å¯¹å¤š)&lt;/li&gt;
  &lt;li&gt;spuä¸‹ æ¯ä¸ªé”€å”®å±æ€§å€¼å¯¹åº”çš„sku(ä¸€å¯¹å¤š)&lt;/li&gt;
&lt;/ol&gt;

&lt;blockquote&gt;
  &lt;p&gt;ç®€æ˜“E-Rå…³ç³»å›¾&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FoUZKUxivUTVSLV4bF8YK293hrsM&quot; alt=&quot;FoUZKUxivUTVSLV4bF8YK293hrsM&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;è¿­ä»£&quot;&gt;è¿­ä»£&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2020å¹´05æœˆ24æ—¥ 13:39:44 åˆç¨¿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;å‚è€ƒ&quot;&gt;å‚è€ƒï¼š&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;1ã€&lt;a href=&quot;https://github.com/skr-shop/manuals&quot;&gt;GitHub - skr-shop/manuals: Do design No code ğŸ’»ğŸ“±ğŸ›’ğŸ“š&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Sun, 24 May 2020 00:00:00 +0800</pubDate>
				<link>/spu-sku.html</link>
				<guid isPermaLink="true">/spu-sku.html</guid>
			</item>
		
			<item>
				<title>é‡å­¦ MySQL çš„Left Joinæ“ä½œ</title>
				<description>&lt;p&gt;è½¯ä»¶ç‰ˆæœ¬ï¼šmysql8.0.18&lt;/p&gt;

&lt;h2 id=&quot;èµ·å› &quot;&gt;èµ·å› &lt;/h2&gt;
&lt;p&gt;ä»Šæ—¥æœ‰ä¸ªéœ€æ±‚ï¼Œæ ¹æ®é—¨åº—æµæ°´ç®—å‡ºç›´è¥é—¨åº—å½“æœˆçš„ä½¿ç”¨å¤©æ•°ã€‚è¿™éœ€æ±‚å¤§æ¦‚åªéœ€è¦é—¨åº—è¡¨å’Œé—¨åº—æµæ°´è¡¨å³å¯ï¼Œçœ‹ä¸Šå»æŒºç®€å•ï¼Œä¸¤å¼ è¡¨left joinï¼Œç„¶ågroup by
å°±èƒ½è§£å†³ï¼Œä½†æ˜¯è°ƒæ•´äº†ä¸‹ï¼Œç»“æœå´ä¸ä¸€æ ·äº†ï¼Œæ„Ÿåˆ°è¿·æƒ‘ã€‚æˆ‘å¤§æ¦‚åªè®°å¾—ï¼Œä»¥å·¦è¾¹ä¸ºä¸»ï¼Œéå†å³è¾¹ï¼Œonåé¢æ¡ä»¶åŒ¹é…ï¼ŒåŒ¹é…å¤±è´¥çš„è¯å³è¾¹å­—æ®µå¼„æˆnullã€‚
ä½†æ˜¯ï¼Œè¿™ä¸è¶³ä»¥è§£ç­”æˆ‘çš„ç–‘æƒ‘ï¼Œæ‰€ä»¥é‡æ–°å­¦ä¹ ä¸‹joinçš„æ“ä½œåŸç†ã€‚&lt;/p&gt;

&lt;h2 id=&quot;æµ‹è¯•çš„sql&quot;&gt;æµ‹è¯•çš„Sql&lt;/h2&gt;
&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NAMES&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;utf8mb4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FOREIGN_KEY_CHECKS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;-- ----------------------------&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- Table structure for store&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- ----------------------------&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;DROP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IF&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;EXISTS&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;`id`&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AUTO_INCREMENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;`name`&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;varchar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COLLATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;utf8mb4_unicode_ci&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'é—¨åº—åç§°'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;`business_type`&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tinyint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;255&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'é—¨åº—ç±»å‹:1ç›´è¥2åŠ ç›Ÿ'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;KEY&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;`id`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ENGINE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InnoDB&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AUTO_INCREMENT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CHARSET&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;utf8mb4&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COLLATE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;utf8mb4_unicode_ci&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;-- ----------------------------&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- Records of store&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- ----------------------------&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;BEGIN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'é—¨åº—A'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'é—¨åº—B'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'é—¨åº—C'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'é—¨åº—D'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;COMMIT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;-- ----------------------------&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- Table structure for store_wallet_bill&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- ----------------------------&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;DROP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IF&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;EXISTS&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store_wallet_bill`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store_wallet_bill`&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;`id`&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AUTO_INCREMENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;`bill`&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;decimal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'æµæ°´'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;`store_id`&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'é—¨åº—id'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;`create_time`&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;datetime&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'ç”Ÿæˆæ—¶é—´'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;KEY&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;`id`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ENGINE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InnoDB&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AUTO_INCREMENT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CHARSET&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;utf8mb4&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COLLATE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;utf8mb4_unicode_ci&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;-- ----------------------------&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- Records of store_wallet_bill&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- ----------------------------&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;BEGIN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store_wallet_bill`&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'2020-05-10 21:29:49'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store_wallet_bill`&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'2020-05-03 21:30:11'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store_wallet_bill`&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'2020-05-07 21:30:18'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store_wallet_bill`&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'2020-05-06 21:30:42'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store_wallet_bill`&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'2020-05-08 21:30:54'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store_wallet_bill`&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'2020-05-08 21:31:10'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;COMMIT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FOREIGN_KEY_CHECKS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;ä¸¤æ¡sqlè¯­å¥ä¸ºä»€ä¹ˆç»“æœä¸åŒ&quot;&gt;ä¸¤æ¡Sqlè¯­å¥ä¸ºä»€ä¹ˆç»“æœä¸åŒ&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;1ã€ç¬¬ä¸€æ¡Sql&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;business_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;SUM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;`store_wallet_bill`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bill&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'sum_bill'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;COUNT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DISTINCT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;LEFT&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store_wallet_bill`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;create_time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'use_day'&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;LEFT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;JOIN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;store_wallet_bill&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;store_wallet_bill&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;store_id&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;business_type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;	
&lt;span class=&quot;k&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;store_id&lt;/span&gt; 
&lt;span class=&quot;k&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;`use_day`&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;desc&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;æ˜¾ç¤º:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;name&lt;/th&gt;
      &lt;th&gt;business_type&lt;/th&gt;
      &lt;th&gt;sum_bill&lt;/th&gt;
      &lt;th&gt;use_day&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;é—¨åº—A&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;3.00&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;é—¨åº—C&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;2.00&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;é—¨åº—D&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;(NULL)&lt;/td&gt;
      &lt;td&gt;0&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
  &lt;p&gt;2ã€ç¬¬äºŒæ¡Sqlï¼Œå°†ç¬¬ä¸€æ¡Sqlçš„whereåé¢çš„&lt;code class=&quot;highlighter-rouge&quot;&gt;store&lt;/code&gt;.business_type = 1ç§»åˆ°left joinçš„onåé¢ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;business_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;SUM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;`store_wallet_bill`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bill&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'sum_bill'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;COUNT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DISTINCT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;LEFT&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store_wallet_bill`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;create_time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'use_day'&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;LEFT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;JOIN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;store_wallet_bill&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;store_wallet_bill&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;store_id&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`store`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;business_type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;	
&lt;span class=&quot;k&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;store_id&lt;/span&gt; 
&lt;span class=&quot;k&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;`use_day`&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;desc&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;æ˜¾ç¤º:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;name&lt;/th&gt;
      &lt;th&gt;business_type&lt;/th&gt;
      &lt;th&gt;sum_bill&lt;/th&gt;
      &lt;th&gt;use_day&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;é—¨åº—A&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;3.00&lt;/td&gt;
      &lt;td&gt;3&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;é—¨åº—C&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
      &lt;td&gt;2.00&lt;/td&gt;
      &lt;td&gt;1&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;é—¨åº—B&lt;/td&gt;
      &lt;td&gt;2&lt;/td&gt;
      &lt;td&gt;(NULL)&lt;/td&gt;
      &lt;td&gt;0&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;mysqlçš„left-joinè§£æ&quot;&gt;Mysqlçš„Left Joinè§£æ&lt;/h2&gt;
&lt;p&gt;mysql å¯¹äºleft joinçš„é‡‡ç”¨ç±»ä¼¼åµŒå¥—å¾ªç¯çš„æ–¹å¼æ¥è¿›è¡Œä»å¤„ç†ï¼Œä»¥ä¸‹é¢çš„è¯­å¥ä¸ºä¾‹ï¼š&lt;/p&gt;
&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;LEFT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;JOIN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;P1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;P2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;å…¶ä¸­P1æ˜¯onè¿‡æ»¤æ¡ä»¶ï¼Œç¼ºå¤±åˆ™è®¤ä¸ºæ˜¯TRUEï¼ŒP2æ˜¯whereè¿‡æ»¤æ¡ä»¶ï¼Œç¼ºå¤±ä¹Ÿè®¤ä¸ºæ˜¯TRUEï¼Œè¯¥è¯­å¥çš„æ‰§è¡Œé€»è¾‘ä¼ªä»£ç å¤§æ¦‚å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;FOR each row lt in LT {   // éå†å·¦è¡¨çš„æ¯ä¸€è¡Œ
  BOOL b = FALSE;
  FOR each row rt in RT such that P1(lt, rt) {// éå†å³è¡¨æ¯ä¸€è¡Œï¼Œæ‰¾åˆ°æ»¡è¶³joinæ¡ä»¶çš„è¡Œ !!!!æ³¨æ„è¿™é‡Œï¼Œè¿™å°±æ˜¯onåé¢åŠ ä¸Š`store`.business_type = 1ä½†æ˜¯è¿˜æ˜¯ä¼šå‡ºç°business_type=2çš„åŸå› 
    IF P2(lt, rt) {//æ»¡è¶³ where è¿‡æ»¤æ¡ä»¶
      t:=lt||rt;//åˆå¹¶è¡Œï¼Œè¾“å‡ºè¯¥è¡Œ
    }
    b=TRUE;// ltåœ¨RTä¸­æœ‰å¯¹åº”çš„è¡Œ
  }
  IF (!b) { // éå†å®ŒRTï¼Œå‘ç°ltåœ¨RTä¸­æ²¡æœ‰æœ‰å¯¹åº”çš„è¡Œï¼Œåˆ™å°è¯•ç”¨nullè¡¥ä¸€è¡Œ  
    IF P2(lt,NULL) {// è¡¥ä¸Šnullåæ»¡è¶³ where è¿‡æ»¤æ¡ä»¶
      t:=lt||NULL; // è¾“å‡ºltå’Œnullè¡¥ä¸Šçš„è¡Œ
    }         
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;ä»ä¸Šé¢çš„ä¼ªä»£ç å¯ä»¥è§£ææˆ‘ä¸Šé¢çš„ä¸¤æ¡Sqlä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªç»“æœäº†&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;ä¸¤æ¡sqlç–‘æƒ‘è§£æ&quot;&gt;ä¸¤æ¡Sqlç–‘æƒ‘è§£æ&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;1ã€ç¬¬ä¸€æ¡Sql&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä»ä¸Šé¢çš„ä¼ªä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå·¦è¾¹storeè¡¨çš„name=â€™é—¨åº—Dâ€™çš„æ•°æ®åœ¨å³è¾¹åŒ¹é…ä¸åˆ°ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªéå†éƒ½æ»¡è¶³ä¸äº†ï¼Œè€Œæ»¡è¶³äº†IF (!b) ï¼Œæ‰€ä»¥å³è¾¹æ˜¯nullã€‚
é‚£ä¹ˆname=â€™é—¨åº—Bâ€™æ€ä¹ˆä¸è§è¿™ä¸€æ¡å‘¢ï¼Ÿå› ä¸ºæ»¡è¶³äº†ç¬¬äºŒä¸ªéå†ï¼Œä½†æ˜¯ä¸æ»¡è¶³ IF P2(lt, rt) è¿‡æ»¤æ¡ä»¶è€Œb=TRUEï¼Œæ‰€ä»¥è¿™å·¦è¾¹name=â€™é—¨åº—Bâ€™ä¸€æ¡éƒ½æ²¡
ç»„åˆåˆ°ã€‚&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;2ã€ç¬¬äºŒæ¡Sql&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä»ä¸Šé¢çš„ä¼ªä»£ç å¯ä»¥çœ‹åˆ°ï¼Œonåé¢åŠ ä¸Š&lt;code class=&quot;highlighter-rouge&quot;&gt;store&lt;/code&gt;.business_type = 1 ã€‚å·¦è¾¹storeè¡¨çš„name=â€™é—¨åº—Dâ€™ æ»¡è¶³ç¬¬äºŒä¸ªéå†æ¡ä»¶ï¼Œä¸æ»¡è¶³IF P2(lt, rt) ï¼Œ
æ‰€ä»¥ä¸€æ¡éƒ½æ²¡ã€‚å·¦è¾¹storeè¡¨çš„name=â€™é—¨åº—Bâ€™,ä¸æ»¡è¶³ç¬¬äºŒä¸ªéå†æ¡ä»¶ï¼Œæ‰€ä»¥å³è¾¹æ˜¯nullã€‚&lt;/p&gt;

&lt;h2 id=&quot;è±ç„¶å¼€æœ—&quot;&gt;è±ç„¶å¼€æœ—&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;1ã€åœ¨left joinä¸­ï¼Œä¸æ˜¯å·¦å³éå†å®Œäº†åå†whereçš„ï¼ˆæˆ‘åœ¨æ­¤ä¹‹å‰éƒ½ä»¥ä¸ºæ˜¯è¿™æ ·çš„ï¼‰ï¼Œè€Œæ˜¯æ¯æ¡éå†éƒ½whereã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;æ³¨æ„&quot;&gt;æ³¨æ„&lt;/h2&gt;

&lt;p&gt;Mysql5.7+ç‰ˆæœ¬é™åˆ¶ä½¿ç”¨GROUP BY çš„select ç­›é€‰å…ƒç´ ï¼ŒæŠ¥é”™å¤§æ¦‚å¦‚ä¸‹&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;SELECT list is not in GROUP BY clause and contains nonaggregated column 'userinfo.t_long.user_name' which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;1ã€ä¸´æ—¶æ€§è§£å†³æ–¹æ¡ˆ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;select @@sql_mode; //ä¼šæ˜¾ç¤ºä¸€äº›sql_modeå±æ€§
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ç„¶åå»æ‰ ONLY_FULL_GROUP_BYï¼Œé‡æ–°è®¾ç½®&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;set global sql_mode='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';
set session sql_mode='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;2ã€æ°¸ä¹…æ›´æ”¹&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä¿®æ”¹my.iniï¼Œå»æ‰ONLY_FULL_GROUP_BYï¼Œé‡å¯æœåŠ¡&lt;/p&gt;

&lt;h2 id=&quot;è¿­ä»£&quot;&gt;è¿­ä»£&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2020å¹´05æœˆ24æ—¥ 00:17:00 åˆç¨¿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;å‚è€ƒ&quot;&gt;å‚è€ƒï¼š&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;1ã€&lt;a href=&quot;https://zhuanlan.zhihu.com/p/93445040&quot;&gt;MySQLï¼šleft join é¿å‘æŒ‡å— - çŸ¥ä¹&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Tue, 12 May 2020 00:00:00 +0800</pubDate>
				<link>/mysql-join.html</link>
				<guid isPermaLink="true">/mysql-join.html</guid>
			</item>
		
			<item>
				<title>ä½¿ç”¨Linuxçš„cpuæŒ–xmrå¸</title>
				<description>&lt;p&gt;ç³»ç»Ÿç‰ˆæœ¬ï¼šCentOS Linux release 7.6.1810 (Core)&lt;/p&gt;

&lt;h2 id=&quot;1åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„ç”¨æˆ·&quot;&gt;1ã€åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„ç”¨æˆ·&lt;/h2&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;useradd coin
passwd coin
visudo //ç»™sudoæƒé™ï¼Œä½ æ‡‚å¾—
su coin
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;2ç¼–è¯‘å’Œå®‰è£…xmr-stakcmake3å‘½ä»¤åé¢çš„å‚æ•°å£°æ˜åªä½¿ç”¨cpuè¿›è¡ŒæŒ–çŸ¿&quot;&gt;2ã€ç¼–è¯‘å’Œå®‰è£…xmr-stakï¼Œcmake3å‘½ä»¤åé¢çš„å‚æ•°å£°æ˜åªä½¿ç”¨CPUè¿›è¡ŒæŒ–çŸ¿&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;å®‰è£…ä¾èµ–&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo yum install -y centos-release-scl epel-release
sudo yum install -y cmake3 devtoolset-4-gcc* hwloc-devel libmicrohttpd-devel openssl-devel make git
//ä¸´æ—¶ä½¿ç”¨devtoolset-4
scl enable devtoolset-4 bash
//ä¸‹è½½æº
git clone https://github.com/fireice-uk/xmr-stak.git
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;åˆ‡æ¢gitä»“åº“åˆ†æ”¯ç‰ˆæœ¬&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å› ä¸ºmasteråˆ†æ”¯å»æ‰äº†Moneroå¸ï¼Œè€Œä¸”å‰©ä¸‹çš„éƒ½æ˜¯äº›æ— åå¸ã€‚&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd xmr-stak
git fetch origin xmr-stak-rx
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;ç¼–è¯‘å®‰è£…ï¼Œåªä½¿ç”¨CPUè¿›è¡ŒæŒ–çŸ¿&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mkdir build
cd build
sudo cmake3 -DCUDA_ENABLE=OFF -DOpenCL_ENABLE=OFF ..
sudo make install
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;3å¯åŠ¨ç¨‹åºå¡«å†™å¸é’±åŒ…åœ°å€çŸ¿æ± ipç­‰&quot;&gt;3ã€å¯åŠ¨ç¨‹åºï¼Œå¡«å†™å¸é’±åŒ…åœ°å€ã€çŸ¿æ± ipç­‰&lt;/h2&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./bin/xmr-stak-rx //ä¹‹åæœ‰æç¤ºå¡«å†™é’±åŒ…åœ°å€å’ŒçŸ¿æ± ipåœ°å€ï¼Œå…¶ä»–ä¿¡æ¯éƒ½æ˜¯æ¬¡è¦çš„
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;./bin/xmr-stak-rx å¯ä»¥å…ˆçœ‹çœ‹é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œç„¶ååœ¨nohup ./bin/xmr-stak-rx &amp;amp; æŒ‚è½½åœ¨åå°&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;4é’±åŒ…çš„åˆ›å»ºå’ŒçŸ¿æ± ipæŸ¥æ‰¾&quot;&gt;4ã€é’±åŒ…çš„åˆ›å»ºã€å’ŒçŸ¿æ± ipæŸ¥æ‰¾&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;4.1ã€ä¸‹è½½é’±åŒ…é“¾æ¥ï¼Œå¯ç”Ÿæˆé’±åŒ…åœ°å€ï¼Œæ”¯æŒå¤šç§OSï¼Œç‚¹å‡»&lt;a href=&quot;https://web.getmonero.org/downloads/&quot;&gt;Downloads&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;4.2ã€å®˜ç½‘å¯ä»¥æ‰¾åˆ°çŸ¿æ± ipï¼Œç‚¹å‡»&lt;a href=&quot;https://monerohash.com/#&quot;&gt;MoneroHash - Monero Mining Pool&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;5åè¯&quot;&gt;5ã€åè¯&lt;/h2&gt;
&lt;p&gt;2å°å››æ ¸æœåŠ¡å™¨æ”¶ç›Šå›¾ï¼Œè·‘äº†9ä¸ªå°æ—¶å·¦å³ï¼Œæ”¶ç›Šæœ‰ç‚¹ä½ï¼Œå½“æ—¶xmrå¸‚åœºä»·æ ¼ä¸º57.84USDã€‚
&lt;img src=&quot;http://img.zzhpeng.cn/Fr9Zq23WuchKUcBHAZB7gwhCIZvR&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;è¿­ä»£&quot;&gt;è¿­ä»£&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2020å¹´04æœˆ09æ—¥ 09:00:00 åˆç¨¿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;å‚è€ƒ&quot;&gt;å‚è€ƒï¼š&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;1ã€&lt;a href=&quot;https://monerohash.com/#getting_started&quot;&gt;MoneroHash - Monero Mining Pool&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Thu, 09 Apr 2020 00:00:00 +0800</pubDate>
				<link>/xmr-mining.html</link>
				<guid isPermaLink="true">/xmr-mining.html</guid>
			</item>
		
			<item>
				<title>å±€åŸŸç½‘WebæœåŠ¡é…ç½®frpç©¿é€ä¸SSLè¯ä¹¦</title>
				<description>&lt;h2 id=&quot;æ­å»ºfrpç©¿é€ç»“æ„å›¾ä¸sslæ€è·¯&quot;&gt;æ­å»ºfrpç©¿é€ç»“æ„å›¾ä¸sslæ€è·¯&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;ç»“æ„å›¾&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;https://img.zzhpeng.cn/FmRqrie4RVbiI2K2S_LporMhjaCH&quot; alt=&quot;Fu0ZUUtbHNQ0b4nh7d2QN4_LJvtB&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;SSLæ€è·¯&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;Frp&lt;/strong&gt;(https://github.com/fatedier/frp)æœ‰æä¾›sslè®¾ç½®ã€‚ä½†æ˜¯ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼ŒæŠŠè¯ä¹¦è®¾ç½®éƒ½æ”¾åœ¨nginxä¸­ã€‚ç„¶åå¤–ç½‘frp serveråˆ°å±€åŸŸç½‘éƒ½æ˜¯ç”¨çš„æ˜¯http typeæœåŠ¡è€Œä¸æ˜¯https typeï¼Œç„¶åæˆ‘ä»¬åªéœ€è¦åœ¨å¤–ç½‘çš„nginxé…ç½®å°±å¯ä»¥äº†ã€‚&lt;/p&gt;

&lt;h2 id=&quot;é…ç½®&quot;&gt;é…ç½®&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;1ã€å±€åŸŸç½‘æœåŠ¡å™¨frpc.ini&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;frps.ini è®¾ç½®:
[common]
bind_port = 7000
token = jq666
vhost_http_port = 8000
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;2ã€å¤–ç½‘æœåŠ¡å™¨frps.iniè®¾ç½®&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[common]
server_addr = xxx.xx.188.48//å¤–ç½‘ip
server_port = 7000
token = jq666

[web1]
type = http
local_ip = 127.0.0.1
local_port = 80
custom_domains = gitlab.xxx.com

[web2]
type = http
local_ip = 127.0.0.1
local_port = 80
custom_domains = packagist.xxx.com
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;3ã€å…¬ç½‘æœåŠ¡å™¨nginxé…ç½®&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;server {
    listen 80;
	listen 443 ssl http2;
    server_name gitlab.xxx.com;
    
    #SSL-START SSLç›¸å…³é…ç½®ï¼Œè¯·å‹¿åˆ é™¤æˆ–ä¿®æ”¹ä¸‹ä¸€è¡Œå¸¦æ³¨é‡Šçš„404è§„åˆ™
    #error_page 404/404.html;
    ssl_certificate    /etc/letsencrypt/live/gitlab.xxx.com/fullchain.pem;
    ssl_certificate_key    /etc/letsencrypt/live/gitlab.xxx.com/privkey.pem;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    error_page 497  https://$host$request_uri;
    #SSL-END
    
    #ERROR-PAGE-START  é”™è¯¯é¡µé…ç½®ï¼Œå¯ä»¥æ³¨é‡Šã€åˆ é™¤æˆ–ä¿®æ”¹
    error_page 404 /404.html;
    error_page 502 /502.html;
    #ERROR-PAGE-END
    
    #PHP-INFO-START  PHPå¼•ç”¨é…ç½®ï¼Œå¯ä»¥æ³¨é‡Šæˆ–ä¿®æ”¹
    include enable-php-00.conf;
    #PHP-INFO-END
    
    #REWRITE-START URLé‡å†™è§„åˆ™å¼•ç”¨,ä¿®æ”¹åå°†å¯¼è‡´é¢æ¿è®¾ç½®çš„ä¼ªé™æ€è§„åˆ™å¤±æ•ˆ
    include /www/server/panel/vhost/rewrite/gitlab.xxx.com.conf;
    #REWRITE-END
    
    location / {
      client_max_body_size 0;
      gzip off;

      proxy_read_timeout      300;
      proxy_connect_timeout   300;
      proxy_redirect          off;

      proxy_http_version 1.1;

      proxy_set_header    Host                $http_host;
      #proxy_set_header	Host 				$host:$server_port;
      proxy_set_header    X-Real-IP           $remote_addr;
      proxy_set_header    X-Forwarded-Ssl     on;
      proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
      proxy_set_header    X-Forwarded-Proto   $scheme;
      proxy_pass http://127.0.0.1:8000;
 	}
    
    access_log  /www/wwwlogs/gitlab.xxx.com.log;
    error_log  /www/wwwlogs/gitlab.xxx.com.error.log;
 }

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;4ã€å†…ç½‘æœåŠ¡å™¨nginxé…ç½®&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä¸Šé¢çš„ä¸¾ä¾‹ï¼Œå»æ‰sslè®¾ç½®å³æ˜¯&lt;/p&gt;

&lt;h2 id=&quot;å®å¡”è¯ä¹¦ç”³è¯·&quot;&gt;å®å¡”è¯ä¹¦ç”³è¯·&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;1ã€åˆ°å®å¡”ç®¡ç†åå°ï¼Œç”³è¯·sslè¯ä¹¦&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;1.1ã€ç”³è¯·åŸŸåï¼ŒdnséªŒè¯&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://img.zzhpeng.cn/FuAgURKSUppIzRm4OJOv4LPemWAN&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;1.2ã€å¦‚ä¸‹å›¾ï¼Œç‚¹å‡»&lt;strong&gt;è¯¦æƒ…&lt;/strong&gt;å¯ä»¥çœ‹åˆ°è¦åœ¨åŸŸåè§£æé‡ŒåŠ å¤šæ¡TXTè§£æ,æ·»åŠ åç‚¹å‡»&lt;strong&gt;éªŒè¯åŸŸå&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://img.zzhpeng.cn/Fr-ZQCVz520OpUGgvNPhqVbCRWA9&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;1.3ã€é˜¿é‡Œäº‘åŸŸåè§£æ&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://img.zzhpeng.cn/FtHdG_-WRGQ1GDd3HLgpsNIhvPos&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;è¿­ä»£&quot;&gt;è¿­ä»£&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2020å¹´02æœˆ11æ—¥ 21:54:00 åˆç¨¿&lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Tue, 11 Feb 2020 00:00:00 +0800</pubDate>
				<link>/frp-ssl.html</link>
				<guid isPermaLink="true">/frp-ssl.html</guid>
			</item>
		
			<item>
				<title>mycat æ•°æ®åº“åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶å­¦ä¹ </title>
				<description>&lt;h2 id=&quot;å®‰è£…ä¸å¯åŠ¨&quot;&gt;å®‰è£…ä¸å¯åŠ¨&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;å®‰è£…&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å®˜ç½‘ï¼šhttp://www.mycat.io/ï¼Œæˆ‘ä¸‹è½½çš„æ˜¯macç‰ˆæœ¬http://dl.mycat.io/1.6.5/Mycat-server-1.6.5-release-20180122220033-mac.tar.gz&lt;/p&gt;

&lt;p&gt;mycatæ˜¯åŸºäºjavaçš„ï¼Œéœ€è¦ç¯å¢ƒä¾èµ–ï¼Œæˆ‘å®‰è£…äº†openjdk1.8çš„&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;âœ  mycat java -version
java version &quot;1.8.0_221&quot;
Java(TM) SE Runtime Environment (build 1.8.0_221-b11)
Java HotSpot(TM) 64-Bit Server VM (build 25.221-b11, mixed mode)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è§£å‹å‹ç¼©åŒ…ï¼Œtar -zxvf Mycat-server-1.6.5-release-20180122220033-mac.tar.gz&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;å¯åŠ¨&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;è¿›å…¥æ–‡ä»¶å¤¹å†…&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd mycat
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å¯åŠ¨&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;âœ  mycat bin/mycat start
Starting Mycat-server...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æŸ¥çœ‹å¯åŠ¨æ˜¯å¦æˆåŠŸ&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;âœ  mycat more logs/wrapper.log
STATUS | wrapper  | 2020/01/11 15:21:51 | --&amp;gt; Wrapper Started as Daemon
STATUS | wrapper  | 2020/01/11 15:21:51 | Launching a JVM...
INFO   | jvm 1    | 2020/01/11 15:21:51 | Java HotSpot(TM) 64-Bit Server VM warning: ignoring option MaxPermSize=64M; support was removed in 8.0
INFO   | jvm 1    | 2020/01/11 15:21:53 | Wrapper (Version 3.2.3) http://wrapper.tanukisoftware.org
INFO   | jvm 1    | 2020/01/11 15:21:53 |   Copyright 1999-2006 Tanuki Software, Inc.  All Rights Reserved.
INFO   | jvm 1    | 2020/01/11 15:21:53 | 
INFO   | jvm 1    | 2020/01/11 15:21:55 | MyCAT Server startup successfully. see logs in logs/mycat.log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;é…ç½®è¯´æ˜&quot;&gt;é…ç½®è¯´æ˜&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;server.xml&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ä½œç”¨ï¼š&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;1ã€é…ç½®ç³»ç»Ÿç›¸å…³å‚æ•°&lt;/p&gt;

&lt;p&gt;2ã€é…ç½®ç”¨æˆ·è®¿é—®æƒé™&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    &amp;lt;user name=&quot;root&quot; defaultAccount=&quot;true&quot;&amp;gt;
            &amp;lt;property name=&quot;password&quot;&amp;gt;123456&amp;lt;/property&amp;gt;
            &amp;lt;property name=&quot;schemas&quot;&amp;gt;TESTDB&amp;lt;/property&amp;gt;

            &amp;lt;!-- è¡¨çº§ DML æƒé™è®¾ç½® --&amp;gt;
            &amp;lt;!--            
            &amp;lt;privileges check=&quot;false&quot;&amp;gt;
                    &amp;lt;schema name=&quot;TESTDB&quot; dml=&quot;0110&quot; &amp;gt;
                            &amp;lt;table name=&quot;tb01&quot; dml=&quot;0000&quot;&amp;gt;&amp;lt;/table&amp;gt;
                            &amp;lt;table name=&quot;tb02&quot; dml=&quot;1111&quot;&amp;gt;&amp;lt;/table&amp;gt;  //dml å››ä½æ•°ä¾æ¬¡insert,update,select,delete
                    &amp;lt;/schema&amp;gt;
            &amp;lt;/privileges&amp;gt;           
             --&amp;gt;
    &amp;lt;/user&amp;gt;

    &amp;lt;user name=&quot;user&quot;&amp;gt;
            &amp;lt;property name=&quot;password&quot;&amp;gt;user&amp;lt;/property&amp;gt;
            &amp;lt;property name=&quot;schemas&quot;&amp;gt;TESTDB&amp;lt;/property&amp;gt;
            &amp;lt;property name=&quot;readOnly&quot;&amp;gt;true&amp;lt;/property&amp;gt;
    &amp;lt;/user&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3ã€é…ç½®SQLé˜²ç«å¢™åŠSQLæ‹¦æˆªåŠŸèƒ½&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;log4j2.xml&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ä½œç”¨ï¼š&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;1ã€é…ç½®è¾“å‡ºæ—¥å¿—çš„æ ¼å¼&lt;/p&gt;

&lt;p&gt;2ã€é…ç½®è¾“å‡ºæ—¥å¿—çš„çº§åˆ«&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;rule.xml&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ä½œç”¨ï¼š&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;1ã€é…ç½®æ°´å¹³åˆ†ç‰‡çš„åˆ†ç‰‡è§„åˆ™&lt;/p&gt;

&lt;p&gt;2ã€é…ç½®åˆ†ç‰‡è§„åˆ™æ‰€å¯¹åº”çš„åˆ†ç‰‡å‡½æ•°&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;ç®€å•å–æ¨¡partitionByMod&lt;/li&gt;
  &lt;li&gt;hashå–æ¨¡partitionByHashMod&lt;/li&gt;
  &lt;li&gt;æšä¸¾åˆ†ç‰‡partitionByFileMap&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;schema.xml&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å®šä¹‰é€»è¾‘åº“å…·ä½“é…ç½®&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; &amp;lt;table name=&quot;company&quot; primaryKey=&quot;ID&quot; type=&quot;global&quot; dataNode=&quot;dn1,dn2,dn3&quot; /&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;primaryKeyå¦‚æœåˆ†ç‰‡çš„åˆ†ç‰‡è§„åˆ™ä¸æ˜¯å®šä¹‰çš„å€¼ï¼Œä¼šå¦å¤–å»ºç«‹ä¸»é”®ç´¢å¼•ã€‚&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;dataHost name=&quot;localhost1&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;0&quot;
                  writeType=&quot;0&quot; dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;1&quot;  slaveThreshold=&quot;100&quot;&amp;gt;
        &amp;lt;heartbeat&amp;gt;select user()&amp;lt;/heartbeat&amp;gt;
        &amp;lt;!-- can have multi write hosts --&amp;gt;
        &amp;lt;writeHost host=&quot;hostM1&quot; url=&quot;localhost:3306&quot; user=&quot;root&quot;
                           password=&quot;123456&quot;&amp;gt;
                &amp;lt;!-- can have multi read hosts --&amp;gt;
                &amp;lt;readHost host=&quot;hostS2&quot; url=&quot;192.168.1.200:3306&quot; user=&quot;root&quot; password=&quot;xxx&quot; /&amp;gt;
        &amp;lt;/writeHost&amp;gt;
        &amp;lt;writeHost host=&quot;hostS1&quot; url=&quot;localhost:3316&quot; user=&quot;root&quot;
                           password=&quot;123456&quot; /&amp;gt;
        &amp;lt;!-- &amp;lt;writeHost host=&quot;hostM2&quot; url=&quot;localhost:3316&quot; user=&quot;root&quot; password=&quot;123456&quot;/&amp;gt; --&amp;gt;
&amp;lt;/dataHost&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;balance=â€0â€&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;0 ä¸å¼€å¯è¯»å†™åˆ†ç¦»æœºåˆ¶&lt;/li&gt;
  &lt;li&gt;1 å…¨éƒ¨çš„readHost ä¸ stand by writeHostå‚ä¸selectè¯­å¥çš„è´Ÿè½½å‡è¡¡&lt;/li&gt;
  &lt;li&gt;2 æ‰€æœ‰çš„readHostä¸writeHostéƒ½å‚ä¸selectè¯­å¥çš„è´Ÿè½½å‡è¡¡&lt;/li&gt;
  &lt;li&gt;3 æ‰€æœ‰readHostå‚ä¸selectè¯­å¥çš„è´Ÿè½½å‡è¡¡&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;writeType=â€0â€&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;0ï¼šé»˜è®¤ä¸€å°å†™ï¼Œé«˜å¯ç”¨ï¼Œdownäº†ä¹‹ååˆ‡æ¢åˆ°æŒ‡å®š&lt;/li&gt;
  &lt;li&gt;1ï¼šéšæœº&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;å‚ç›´åˆ†åº“&quot;&gt;å‚ç›´åˆ†åº“&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;1ã€æ”¶é›†åˆ†æä¸šåŠ¡æ¨¡å—é—´çš„å…³ç³»&lt;/li&gt;
  &lt;li&gt;2ã€å¤åˆ¶æ•°æ®åº“åˆ°å…¶ä»–å®ä¾‹&lt;/li&gt;
  &lt;li&gt;3ã€é…ç½®mycatå‚ç›´åˆ†åº“&lt;/li&gt;
  &lt;li&gt;4ã€é€šè¿‡mycatè®¿é—®DB&lt;/li&gt;
  &lt;li&gt;5ã€åˆ é™¤åŸåº“ä¸­å·²è¿ç§»è¡¨&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;ä¼˜ç‚¹&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;1ã€æ•°æ®åº“çš„æ‹†åˆ†ç®€å•æ˜äº†ï¼Œæ‹†åˆ†è§„åˆ™æ˜ç¡®&lt;/li&gt;
  &lt;li&gt;2ã€åº”ç”¨ç¨‹åºæ¨¡å—æ¸…æ™°æ˜ç¡®ï¼Œæ•´åˆå®¹æ˜“&lt;/li&gt;
  &lt;li&gt;3ã€æ•°æ®ç»´æŠ¤æ–¹ä¾¿æ˜“è¡Œï¼Œå®¹æ˜“å®šä½&lt;/li&gt;
  &lt;li&gt;4ã€è¯»å†™å‹åŠ›åˆ†æ‹…&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;ç¼ºç‚¹&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;1ã€æ— æ³•è·¨åˆ†ç‰‡åšå…³è”æŸ¥è¯¢ï¼ˆè§£å†³æ–¹å¼1ã€MyCatå…¨å±€è¡¨ã€‚2ã€å†—ä½™å­—æ®µã€‚3ã€APIè·å–æ•°æ®ï¼‰&lt;/li&gt;
  &lt;li&gt;2ã€å¯¹äºè®¿é—®æå…¶é¢‘ç¹ä¸”æ•°æ®é‡è¶…å¤§çš„è¡¨ä»ç„¶å­˜åœ¨æ€§èƒ½ç“¶é¢ˆ&lt;/li&gt;
  &lt;li&gt;3ã€åˆ‡åˆ†è¾¾åˆ°ä¸€å®šç¨‹åº¦ä¹‹åï¼Œæ‰©å±•æ€§ä¼šé‡åˆ°ç“¶é¢ˆ&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;mycatç®¡ç†å‚ç›´åˆ‡åˆ†çš„ä¼˜ç‚¹&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;1ã€è·¨åˆ†ç‰‡åšå…³è”æŸ¥è¯¢ï¼Œå¯ä»¥é€šè¿‡mycatè®¾ç½®å…¨å±€è¡¨ï¼Œå³æ˜¯å¤šåˆ†ç‰‡éƒ½æœ‰è¿™å¼ è¡¨ã€‚ï¼ˆåªå»ºè®®å°è¡¨è¿›è¡Œæ”¹æ“ä½œï¼‰&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;æ°´å¹³åˆ†ç‰‡&quot;&gt;æ°´å¹³åˆ†ç‰‡&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;åˆ†ç‰‡è§„åˆ™&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;é€šè¿‡è¡¨å­—æ®µä½œä¸ºåˆ†ç‰‡å»ºç®€å•å–æ¨¡åˆ†ç‰‡&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;æ­¥éª¤&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;1ã€æ ¹æ®ä¸šåŠ¡çŠ¶æ€ç¡®å®šè¦åˆ†ç‰‡çš„è¡¨ã€‚&lt;/li&gt;
  &lt;li&gt;2ã€æ ¹æ®ä¸šåŠ¡é€‰æ‹©åˆ†ç‰‡å»ºä»¥åŠç®—æ³•&lt;/li&gt;
  &lt;li&gt;3ã€ä½¿ç”¨MyCatéƒ¨ç½²åˆ†ç‰‡é›†ç¾¤&lt;/li&gt;
  &lt;li&gt;4ã€æµ‹è¯•åˆ†ç‰‡é›†ç¾¤&lt;/li&gt;
  &lt;li&gt;5ã€ä¸šåŠ¡åŠæ•°æ®è¿ç§»&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;åˆ†ç‰‡åé—®é¢˜&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;1åˆ†ç‰‡éœ€è¦è€ƒè™‘ä¸»é”®çš„å…¨å±€å”¯ä¸€æ€§&quot;&gt;1ã€åˆ†ç‰‡éœ€è¦è€ƒè™‘ä¸»é”®çš„å…¨å±€å”¯ä¸€æ€§&lt;/h3&gt;

&lt;p&gt;MyCatæœ‰æä¾›å…¨å±€è‡ªå¢ID&lt;/p&gt;

&lt;h3 id=&quot;2åˆ†ç‰‡åå…³è”&quot;&gt;2ã€åˆ†ç‰‡åå…³è”&lt;/h3&gt;

&lt;p&gt;MyCatçš„E-Råˆ†ç‰‡ï¼Œå°†å…³è”çš„æ•°æ®åˆ†åœ¨ä¸€ä¸ªåˆ†ç‰‡ï¼Œå³æ˜¯éƒ½è¦åšåˆ†ç‰‡ã€‚&lt;/p&gt;

&lt;h2 id=&quot;mycatå…¶ä»–&quot;&gt;MyCatå…¶ä»–&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;1ã€SQLæ‹¦æˆªï¼ŒåŠŸèƒ½ç›‘æ§å†™å…¥sqlå®¡è®¡&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;2ã€SQLé˜²ç«å¢™ï¼ŒåŠŸèƒ½ï¼šè®¾ç½®ç™½åå•é»‘åå•ï¼Œé»‘åå•å¯ä»¥ç¼–å†™é™åˆ¶æ²¡whereçš„deleteè¯­å¥&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;3ã€é€šè¿‡Zookeeperåšå¯åŠ¨å’ŒåŒæ­¥&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;4ã€é€šè¿‡HAProxyåšè´Ÿè½½å‡è¡¡&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;1ã€å®‰è£…&lt;/li&gt;
  &lt;li&gt;2ã€Keepalivedç›‘æ§HAProxy&lt;/li&gt;
  &lt;li&gt;3ã€é…ç½®HAProxyç›‘æ§MyCat&lt;/li&gt;
  &lt;li&gt;4ã€é…ç½®vipè®¿é—®HAProxy&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;mycatè¯»å†™åˆ†ç¦»&quot;&gt;MyCatè¯»å†™åˆ†ç¦»&lt;/h2&gt;

&lt;h2 id=&quot;mycatç®¡ç†å’Œç›‘æ§&quot;&gt;MyCatç®¡ç†å’Œç›‘æ§&lt;/h2&gt;

&lt;p&gt;MyCat-Webå·¥å…·ï¼šhttps://www.cnblogs.com/cuishuai/p/7570597.html&lt;/p&gt;

&lt;h2 id=&quot;mycatåªåšåˆ°äº†å¼±åˆ†å¸ƒå¼äº‹åŠ¡&quot;&gt;MyCatåªåšåˆ°äº†å¼±åˆ†å¸ƒå¼äº‹åŠ¡&lt;/h2&gt;

&lt;h2 id=&quot;è¿­ä»£&quot;&gt;è¿­ä»£&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2020å¹´02æœˆ11æ—¥ 21:54:00 åˆç¨¿&lt;/li&gt;
  &lt;li&gt;2020å¹´02æœˆ24æ—¥ 00:17:00 ä¿®æ”¹&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;å‚è€ƒ&quot;&gt;å‚è€ƒ&lt;/h2&gt;
</description>
				<pubDate>Sat, 11 Jan 2020 00:00:00 +0800</pubDate>
				<link>/mycat-introduction.html</link>
				<guid isPermaLink="true">/mycat-introduction.html</guid>
			</item>
		
			<item>
				<title>iptableså’Œnginxé…ç½®é˜²å¾¡ccå­¦ä¹ </title>
				<description>&lt;h2 id=&quot;é—®é¢˜æ¦‚è¿°&quot;&gt;é—®é¢˜æ¦‚è¿°&lt;/h2&gt;
&lt;p&gt;ä¸Šä¸€ç¯‡æ–‡ç« é…ç½®äº†iptablesä¸¤æ¡å‘½ä»¤ï¼Œå°±è§‰å¾—æ²¡é—®é¢˜äº†ï¼Œä½†æ˜¯æˆ‘å¤ªå¤©çœŸäº†ï¼Œå½’å’åŸå› è¿˜æ˜¯æ²¡æœ‰å¥½å¥½
å­¦iptablesçš„å†…åœ¨æ„æ€ã€‚&lt;/p&gt;

&lt;p&gt;é…ç½®çš„iptablesä¸¤æ¡å‘½ä»¤&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -I INPUT -p tcp --dport 443 -m connlimit --connlimit-above 30 -j REJECT
sudo iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 30 -j REJECT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;è§£é‡Šä¸‹è¿™ä¸¤æ¡å‘½ä»¤ï¼Œæ„æ€éƒ½æ˜¯è¡¨ç¤ºåœ¨åŒä¸€æ—¶åˆ»æœ€å¤§çš„tcpä¸º30è¿æ¥æ•°é™åˆ¶ï¼Œè¶…è¿‡30è¿æ¥æ•°å°±ä¼šè¢«rejectæ‹’ç»ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;è®°ä½æ˜¯åŒä¸€æ—¶åˆ»ï¼ï¼!&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;åŒä¸€æ—¶åˆ»ï¼Œå³æ˜¯tcpå¤„äºESTABLISHEDè¿æ¥çŠ¶æ€çš„ã€‚é‚£è¿™äº›æ€ä¹ˆçœ‹å‘¢ï¼Ÿ&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;æ¡ˆä¾‹&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat -nat  | grep :443

Proto Recv-Q Send-Q Local-Address           Foreign-Address         State
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN     
tcp        0      0 172.18.245.246:443      113.67.9.211:14451      TIME_WAIT  
tcp        0      1 172.18.245.246:42776    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14442      TIME_WAIT  
tcp        0      0 172.18.245.246:42388    47.106.188.48:443       ESTABLISHED
tcp        0      1 172.18.245.246:42748    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14540      TIME_WAIT  
tcp        0      1 172.18.245.246:42690    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42682    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14559      TIME_WAIT  
tcp        0      1 172.18.245.246:42694    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42564    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42706    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:42380    47.106.188.48:443       ESTABLISHED
tcp        0      1 172.18.245.246:42396    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42674    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      47.106.188.48:42236     ESTABLISHED
tcp        0      1 172.18.245.246:42610    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42606    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42592    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:42294    47.106.188.48:443       ESTABLISHED
tcp        0      1 172.18.245.246:42342    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14498      TIME_WAIT  
tcp        0      0 172.18.245.246:443      47.106.188.48:42278     ESTABLISHED
tcp        0      1 172.18.245.246:42558    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      47.106.188.48:42272     ESTABLISHED
tcp        0      0 172.18.245.246:443      47.106.188.48:42252     ESTABLISHED
tcp        0      0 172.18.245.246:443      113.67.9.211:14543      TIME_WAIT  
tcp        0      1 172.18.245.246:42746    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42788    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14570      TIME_WAIT  
tcp        0      0 172.18.245.246:42270    47.106.188.48:443       ESTABLISHED
tcp        0      1 172.18.245.246:42792    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14493      TIME_WAIT  
tcp        0      0 172.18.245.246:42370    47.106.188.48:443       ESTABLISHED
tcp        0      0 172.18.245.246:443      113.67.9.211:14445      TIME_WAIT  
tcp        0      1 172.18.245.246:42688    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42570    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42328    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      47.106.188.48:42292     ESTABLISHED
tcp        0      0 172.18.245.246:42278    47.106.188.48:443       ESTABLISHED
tcp        0      1 172.18.245.246:42216    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14550      TIME_WAIT  
tcp        0      0 172.18.245.246:443      113.67.9.211:14487      TIME_WAIT  
tcp        0      1 172.18.245.246:42774    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14425      TIME_WAIT  
tcp        0      1 172.18.245.246:42726    47.106.188.48:443       SYN_SENT   
tcp        0      1 172.18.245.246:42390    47.106.188.48:443       SYN_SENT   
tcp        0      0 172.18.245.246:443      113.67.9.211:14578      TIME_WAIT  
tcp        0      0 172.18.245.246:443      113.67.9.211:14564      TIME_WAIT 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;ç»Ÿè®¡å¯¹å¤–443ç«¯å£è¿æ¥æ•°&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat -nat|grep &quot;47.106.188.48:443&quot;|wc -l
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;ç»Ÿè®¡å¯¹å¤–443å·²è¿æ¥ä¸Šçš„ï¼ŒçŠ¶æ€ä¸ºESTABLISHED&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat -nat | grep ESTABLISHED | grep 47.106.188.48:443 | wc -l  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;ç»Ÿè®¡å¯¹å¤–443ç­‰å¾…è¿æ¥çš„ï¼ŒçŠ¶æ€ä¸ºSYN_SENT&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat -nat | grep SYN_SENT | grep 47.106.188.48:443 | wc -l  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;iptablesé…ç½®å®Œåï¼Œè¿‡å‡ å¤©åˆå‡ºç°äº†nginxçš„502æƒ…å†µï¼Œåœ¨nginx erroræŸ¥çœ‹å½“æ—¶çš„é‚£ä¸ªæ—¶é—´æ®µçš„è¯¥ipçš„è¯·æ±‚å¤±è´¥æ•°ã€‚&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;grep '2020/01/01 19:02:31' xxx.com.error.log|wc -l   //ç»“æœæ˜¾ç¤º62ä¸ªè¯·æ±‚å¤±è´¥æ•°
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;åˆæ­¥çŒœæƒ³&lt;/code&gt;ï¼šnginx erroræ˜¾ç¤º62ä¸ªè¯·æ±‚å¤±è´¥æ•°! ä¿æŒ30ä¸ªè¿æ¥æ•°é‡ï¼Œä½†æ˜¯è¯·æ±‚å´æ˜¯ä¸€ç›´åœ¨è¯·æ±‚ï¼ŒåŠ¨æ€è¯­è¨€php-cgiå¤„ç†ä¸è¿‡æ¥ï¼Œnginx
ä¼ è¿‡æ¥çš„è¯·æ±‚ï¼Œå°±ä¼šç›´æ¥è¿”å›é”™è¯¯ã€‚å¯¼è‡´nginxç›´æ¥å°†è¯·æ±‚ï¼Œè®°åšé”™è¯¯å†™å…¥erroræ—¥å¿—ã€‚&lt;/p&gt;

&lt;p&gt;ç”»ä¸ªæµç¨‹å›¾ï¼š
&lt;img src=&quot;http://img.zzhpeng.cn/Fk7-M-U3c-LFEmPmzOe_bmNwuRNx&quot; alt=&quot;å›¾&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;iptableså­¦ä¹ ä¸æµ‹è¯•&quot;&gt;iptableså­¦ä¹ ä¸æµ‹è¯•&lt;/h2&gt;
&lt;p&gt;æœ¬æµ‹è¯•åœ¨æµ‹è¯•ç¯å¢ƒæµ‹è¯•ï¼Œç¯å¢ƒå‚æ•°ä¸º4gå†…å­˜2ä¸ªæ ¸å¿ƒ1Må¸¦å®½ï¼Œç³»ç»Ÿç¯å¢ƒæ˜¯ubuntu16.4ï¼Œè¯¥å‘è¡Œç‰ˆæœ¬çš„é»˜è®¤ç®¡ç†é˜²ç«å¢™çš„å·¥å…·æ˜¯ufwã€‚&lt;/p&gt;

&lt;h3 id=&quot;æ— ä»»ä½•é˜²å¾¡æµ‹è¯•&quot;&gt;æ— ä»»ä½•é˜²å¾¡æµ‹è¯•&lt;/h3&gt;
&lt;p&gt;å‹æµ‹æœåŠ¡å™¨abå‘½ä»¤ ab -c 20 -n 1000 https://dev.xxx.com/ï¼Œå…¨éƒ¨é€šè¿‡
&lt;img src=&quot;http://img.zzhpeng.cn/FrN6NF5LYoD3J9BZL37rzHsm0OVK&quot; alt=&quot;abå‘½ä»¤&quot; /&gt;&lt;/p&gt;

&lt;p&gt;æœåŠ¡å™¨tcpè¿æ¥æ•°å˜åŒ–
&lt;img src=&quot;http://img.zzhpeng.cn/FsCP9OnEiddWnKI1bMMQtKdTSEV0&quot; alt=&quot;tcpè¿æ¥æ•°å˜åŒ–&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;iptablesé˜²å¾¡&quot;&gt;iptablesé˜²å¾¡&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;æŸ¥çœ‹iptablesçŠ¶æ€&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo ufw status  //ä¼šæ˜¾ç¤º Status: active ï¼Œè¯æ˜å·²ç»å¼€å¯
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;iptables å‘½ä»¤&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;æ·»åŠ ï¼Œé˜²å¾¡åŒä¸€æ—¶åˆ»20è¿æ¥æ•°é™åˆ¶&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -I INPUT -p tcp --dport 443 -m connlimit --connlimit-above 20 -j REJECT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;åˆ é™¤é˜²å¾¡åŒä¸€æ—¶åˆ»20è¿æ¥æ•°é™åˆ¶&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -D INPUT -p tcp --dport 443 -m connlimit --connlimit-above 20 -j REJECT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æŸ¥çœ‹æ˜¯å¦ç”Ÿæ•ˆ&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -nL
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å¼€æœºç”Ÿæ•ˆ&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;è‡ªæŸ¥
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;iptables æµ‹è¯•&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å‹æµ‹æœåŠ¡å™¨abå‘½ä»¤ ab -c 20 -n 1000 https://dev.xxx.com/ï¼Œå°‘éƒ¨åˆ†å¤±è´¥
&lt;img src=&quot;http://img.zzhpeng.cn/FjGLx-JepP-Q4JvMxYOOnNIMMQEW&quot; alt=&quot;abå‘½ä»¤&quot; /&gt;&lt;/p&gt;

&lt;p&gt;æœåŠ¡å™¨tcpè¿æ¥æ•°å˜åŒ–,å‹æµ‹ä¸­çš„å»ºç«‹è¿æ¥æ•°ä¸è¶…è¿‡20
&lt;img src=&quot;http://img.zzhpeng.cn/FhjpjR9Px6Y4sbo1l6f_d3ek0XIk&quot; alt=&quot;tcpè¿æ¥æ•°å˜åŒ–&quot; /&gt;&lt;/p&gt;

&lt;p&gt;åŠ å¼ºå‹æµ‹ï¼Œå‹æµ‹æœåŠ¡å™¨abå‘½ä»¤ ab -c 25 -n 1000 https://dev.xxx.com/ 
&lt;img src=&quot;http://img.zzhpeng.cn/FoJbn_IqOilb6IX1SYq-npWaMxmA&quot; alt=&quot;abå‘½ä»¤&quot; /&gt;&lt;/p&gt;

&lt;p&gt;æœåŠ¡å™¨tcpè¿æ¥æ•°å˜åŒ–ï¼Œå‹æµ‹ä¸­çš„å»ºç«‹è¿æ¥æ•°ä¸è¶…è¿‡20
&lt;img src=&quot;http://img.zzhpeng.cn/FgjeblbI2m_2fElE8MwK1cs-9Y5M&quot; alt=&quot;tcpè¿æ¥æ•°å˜åŒ–&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;nginx-ccé˜²å¾¡è®¾ç½®&quot;&gt;nginx ccé˜²å¾¡è®¾ç½®&lt;/h2&gt;
&lt;p&gt;å³æ˜¯æ˜¯é…ç½®äº†iptablesè¿˜æ˜¯ä¼šå‡ºç°502ï¼ŒæŸ¥çœ‹å¤§é‡è¯·æ±‚çš„ipï¼Œè¿™ä¸ªipæ˜¯æŸä¸ªæ­£å¸¸ä½¿ç”¨çš„é—¨åº—ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆä¼šå‡ºç°å¤§é‡çš„è¯·æ±‚å‘¢ï¼Ÿ
æ¨æµ‹F5,æ¨¡æ‹Ÿæµ‹è¯•ã€‚&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;F5æ¨¡æ‹Ÿæµ‹è¯•&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;F5æ¨¡æ‹Ÿæµ‹è¯•,æœç„¶ç³»ç»ŸæŠ›å‡º502ï¼Œæˆ‘æŒ‰å‡ºäº†æµè§ˆå™¨æ˜¾ç¤ºå·®ä¸å¤š1200å¤šä¸ªè¯·æ±‚ã€‚
&lt;img src=&quot;http://img.zzhpeng.cn/FkNU7r-CYTOdCTYzFylfeR4PCdFr&quot; alt=&quot;tcpè¿æ¥æ•°å˜åŒ–&quot; /&gt;&lt;/p&gt;

&lt;p&gt;ç„¶åï¼Œæˆ‘åœ¨æµ‹è¯•æœåŠ¡å™¨ï¼ŒæŸ¥çœ‹tcpå˜åŒ–æ•°ï¼Œé™åˆ¶åˆ°äº†20ä¸ªè¿æ¥æ•°ã€‚è‡ªæˆ‘æ¨æµ‹ï¼šæŒç»­1200ä¸ªè¯·æ±‚ä¸‹æ¥ï¼Œ
å­˜åœ¨äº†å¾ˆå¤šç­‰å¾…è¿æ¥çš„ã€‚æ•°æ®åº“è¿”å›æ•°æ®æ…¢äº†æˆ–è€…å¥”æºƒäº†ï¼Œphp-fpmå“åº”è¶…æ—¶é‡å¯å‡ºç°502ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚å›¾ä¸‹ï¼Œä¸ºF5è¯·æ±‚äº§ç”Ÿ502åï¼ŒæŸ¥çœ‹æœåŠ¡å™¨tcpæƒ…å†µï¼Œè¿˜ä¿æŒç€20ä¸ªè¿æ¥æ•°ï¼Œå’Œ80ä¸ªå‡†å¤‡è¿æ¥æ•°ã€‚
&lt;img src=&quot;http://img.zzhpeng.cn/FmQH6dfFWvqmgHrcTF_EcpYUjQPW&quot; alt=&quot;tcpè¿æ¥æ•°å˜åŒ–&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ç»“è®ºï¼šiptableçš„é™åˆ¶20ä¸ªè¿æ¥æ•°ï¼Œèƒ½é™åˆ¶æµé‡ï¼Œä½†æ˜¯F5æ”»å‡»è§¦åŠåˆ°æ•°æ®åº“ï¼Œå°±å­˜åœ¨æ•°æ®åº“é‚£è¾¹çš„è¯»çš„å‹åŠ›ã€‚
å¦‚æœæ˜¯é™æ€æˆ–è€…ç¼“å­˜èµ„æºçš„çš„å“åº”æ˜¯æ²¡é—®é¢˜çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ‰¾åˆ°äº†nginxçš„ccé˜²å¾¡ã€‚é‡åˆ°ä¸€ä¸ªæ—¶é—´æ®µè¿‡å¤šçš„æµé‡å¯ä»¥æŠ›å‡º
ä¸ªç½‘ç»œå¼‚å¸¸æˆ–503å“åº”ç»™æµè§ˆå™¨ï¼Œè¿™æ ·ç”¨æˆ·æŒç»­çš„F5å°±ä¸ä¼šå½±å“æœåŠ¡å™¨äº†&lt;/code&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;nginx.confä¸»é…ç½®&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    limit_conn_zone $binary_remote_addr zone=perip:10m;//è¿œç«¯ip é™åˆ¶ 
    limit_conn_zone $server_name zone=perserver:10m;//æœåŠ¡å™¨åŸŸå é™åˆ¶
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;å®¹å™¨å…±ä½¿ç”¨10Mçš„å†…å­˜æ¥å¯¹äºIPä¼ è¾“å¼€é”€&lt;/code&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;server.confæŸä¸ªç½‘ç«™&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    limit_conn perserver 300;//è¿œç«¯æœåŠ¡å™¨åŸŸå 300ä¸ªå¹¶å‘é™åˆ¶
    limit_conn perip 25;//è¿œç«¯ip25ä¸ªå¹¶å‘ é™åˆ¶
    limit_rate 1024k;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;limit_rate 512kï¼š å¯¹æ¯ä¸ªè¿æ¥é™é€Ÿ512k. æ³¨æ„ï¼Œè¿™é‡Œæ˜¯å¯¹è¿æ¥é™é€Ÿï¼Œè€Œä¸æ˜¯å¯¹IPé™é€Ÿã€‚å¦‚æœä¸€ä¸ªIPå…è®¸ä¸¤ä¸ªå¹¶å‘è¿æ¥ï¼Œé‚£ä¹ˆè¿™ä¸ªIPå°±æ˜¯é™é€Ÿlimit_rateÃ—2ã€‚&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;é…ç½®ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç”¨äº†å®å¡”çš„UIé…ç½®ï¼Œè¿™é‡Œæ˜¯åœ¨serverå¤–éƒ¨é…ç½®çš„ï¼Œå…¨å±€ã€‚
&lt;img src=&quot;http://img.zzhpeng.cn/Fp8s437_mKXOffD-bKDyTub_vxg4&quot; alt=&quot;å®å¡”è®¾ç½®&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;F5å†æ¬¡æ¨¡æ‹Ÿæµ‹è¯•&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å†æ¬¡æ˜¾ç¤ºf5 65æ¬¡å°±ç½‘ç»œå‡ºé”™äº†ï¼Œf5é˜²å¾¡æˆåŠŸã€‚
&lt;img src=&quot;http://img.zzhpeng.cn/Fubhh6oFbkaA5UBA9Et61YUcPFLp&quot; alt=&quot;F5å†æ¬¡æ¨¡æ‹Ÿæµ‹è¯•&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;æç„¶å¤§æ‚Ÿ&quot;&gt;æç„¶å¤§æ‚Ÿ&lt;/h2&gt;
&lt;p&gt;1ã€å‰å‡ æ¬¡å‡ºç°çš„f5æ”»å‡»ï¼Œåªæœ‰ä¸Šåƒæ¡å•ä¸ªipçš„errorå°±åœäº†ï¼Œå¹¶ä¸”å‡ºç°nginx 502ã€‚è€Œæœ€è¿‘f5æ”»å‡»è¾¾åˆ°äº†ä¸Šä¸‡æ¡å•ä¸ªipçš„errorï¼Œè¿™ä¸ªå°±æ˜¯
è®¾ç½®çš„iptablesåšäº†é™åˆ¶ä½œç”¨äº†ï¼Œåªå…è®¸30ä¸ªè¿æ¥æ•°ï¼Œæ•°æ®åº“çŸ­æš‚å‹åŠ›æ²¡é‚£ä¹ˆå¤§ï¼Œå¯ä»¥æŒç»­æ›´é•¿çš„æ—¶é—´ã€‚&lt;/p&gt;

&lt;p&gt;2ã€iptables è®¾ç½®äº†30ä¸ªè¿æ¥æ•°é™åˆ¶ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆå•ä¸ªipä¼šæœ‰ä¸Šä¸‡ä¸ªerroré”™è¯¯å‘¢ï¼Ÿè¿™é‡Œå°±ç‰µç€åˆ°äº†æµè§ˆå™¨http2åè®®å½“ä¸­ï¼Œä¸€ä¸ªtcpå¤šè·¯å¤ç”¨
å¯ä»¥ä¼ è¾“å¤šä¸ªhttpè¯·æ±‚ã€‚&lt;/p&gt;

&lt;h2 id=&quot;è¿­ä»£&quot;&gt;è¿­ä»£&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2020å¹´01æœˆ06æ—¥ 16:54:00 åˆç¨¿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;å‚è€ƒ&quot;&gt;å‚è€ƒ&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://help.ubuntu.com/community/UFW&quot;&gt;UFW - Community Help Wiki&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://help.ubuntu.com/community/IptablesHowTo&quot;&gt;IptablesHowTo - Community Help Wiki&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/MacoLee/p/6023201.html&quot;&gt;Nginxé™é€Ÿé‡åˆ°çš„é—®é¢˜ - MacoLee - åšå®¢å›­&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.httpclient.cn/archives/106.html&quot;&gt;æœåŠ¡å™¨TIME_WAITå’ŒCLOSE_WAITåˆ†æå’Œè§£å†³åŠæ³• - HttpClient ä¸­æ–‡å®˜ç½‘&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/williamjie/p/11075565.html&quot;&gt;ä¸€ä¸ª TCP è¿æ¥å¯ä»¥å‘å¤šå°‘ä¸ª HTTP è¯·æ±‚ - å‰²è‚‰æœº - åšå®¢å›­&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/skynet/p/4173450.html&quot;&gt;Nginx + CGI/FastCGI + C/Cpp - å´ç§¦ - åšå®¢å›­&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<pubDate>Mon, 06 Jan 2020 00:00:00 +0800</pubDate>
				<link>/iptables-nginx-cc.html</link>
				<guid isPermaLink="true">/iptables-nginx-cc.html</guid>
			</item>
		
			<item>
				<title>ç”Ÿäº§ç¯å¢ƒåˆå‡ºç°nginx502äº†ï¼ï¼</title>
				<description>&lt;h2 id=&quot;é—®é¢˜æ¦‚è¿°&quot;&gt;é—®é¢˜æ¦‚è¿°&lt;/h2&gt;
&lt;p&gt;åœ¨æŸæ®µæ—¶é—´æ®µï¼Œç½‘ç«™å‡ºç°nginx 502ï¼Œé€šè¿‡å®å¡”æŸ¥çœ‹ï¼Œè´Ÿè½½çŠ¶æ€æ˜¯100%ï¼ŒæŸ¥çœ‹ç›‘æ§ï¼Œç£ç›˜IOé£™é«˜ï¼Œå¦‚ä¸‹ä¸ºè¿‘7æ—¥IOç£ç›˜å›¾ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FilqyanVhrxGwgOxksnDlyWAnw-W&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;æ’æŸ¥æ•°æ®&quot;&gt;æ’æŸ¥æ•°æ®&lt;/h2&gt;

&lt;p&gt;nginxæŠ›å‡º502ï¼Œè¯æ˜æ˜¯å®ƒçš„åå‘ä»£ç†å‡ºé”™ï¼Œè¿™ä¸ªä»£ç†php-cgiå‡ºäº†é—®é¢˜ï¼Œæˆ‘ç”¨çš„æ˜¯php-fpmï¼Œå‡ºäº†é—®é¢˜ã€‚
æŸ¥çœ‹php-fpm æ—¥å¿—ï¼Œå‘ç°å¹¶æ²¡æœ‰ä»€ä¹ˆå¼‚å¸¸ï¼Œæç¤ºéœ€è¦æå‡start_serversæ˜¯å› ä¸ºåœ¨è¿™ä¸ªæ—¶å€™æˆ‘reloadäº†php-fpmï¼Œ
ä½†æ˜¯reloadåå¹¶æ²¡ä½œç”¨ã€‚ç„¶åé‡å¯äº†nginxï¼Œæ‰æ¢å¤äº†æ­£å¸¸ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FvPOyQL4h5T7VN73ltMSw5TyGP9L&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;p&gt;æŸ¥çœ‹nginx æ—¥å¿—ï¼Œå‡ºç°äº†å¾ˆå¤š*12359859 connect() to unix:/tmp/php-cgi-72.sock failed
 (11: Resource temporarily unavailable) while connecting to upstream&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FqX_zzcPU42pDzGR9dXbL9m-DG3p&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;p&gt;æ ¹æ®nginxè¿™ä¸ªæç¤ºæŸ¥äº†ç›¸å…³èµ„æ–™ï¼Œå¾—åˆ°äº†3ä¸ªè§£å†³æ–¹æ¡ˆ&lt;/p&gt;
&lt;h3 id=&quot;1php-fpmçš„socké€šè®¯æ–¹å¼-æ”¹ä¸º-tcp&quot;&gt;1ã€php-fpmçš„socké€šè®¯æ–¹å¼ æ”¹ä¸º tcp&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ç»“è®ºï¼šä¸è€ƒè™‘ï¼ŒæŸ¥äº†ç›¸å…³çš„blogï¼Œå‡ºç°äº†ç›¸åŒé—®é¢˜ï¼Œè¿˜ä»tcpæ”¹ä¸ºsockæ¨¡å¼å‘¢ï¼ï¼&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;2ç”¨ä¸¤ä¸ªphp-fpm-socknginxè´Ÿè½½å‡è¡¡&quot;&gt;2ã€ç”¨ä¸¤ä¸ªphp-fpm sockï¼Œnginxè´Ÿè½½å‡è¡¡&lt;/h3&gt;
&lt;p&gt;2.1ã€å¤åˆ¶ä¸€ä»½é…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹é‡Œè¾¹çš„pid sock
cp /usr/local/php/etc/php-fpm.conf cp /usr/local/php/etc/php-fpm2.conf&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[global]
pid = /usr/local/php/var/run/php-fpm2.pid
error_log = /usr/local/php/var/log/php-fpm2.log
log_level = notice

[www]
listen = /tmp/php-cgi2.sock
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.2ã€å¤åˆ¶ä¸€ä¸ªå¯åŠ¨æ–‡ä»¶ï¼Œä¹Ÿä¿®æ”¹ç›¸å…³çš„ä¿¡æ¯&lt;/p&gt;

&lt;p&gt;cp /etc/init.d/php-fpm /etc/init.d/php-fpm2&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;php_fpm_BIN=${exec_prefix}/sbin/php-fpm
php_fpm_CONF=${prefix}/etc/php-fpm2.conf
php_fpm_PID=${prefix}/var/run/php-fpm2.pid
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.3ã€å¯åŠ¨
/etc/init.d/php-fpm2 start&lt;/p&gt;

&lt;p&gt;2.4ã€nginx é…ç½®æ–‡ä»¶ï¼Œå¢åŠ  upstreamæ¨¡å—&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;upstream backend{
    server unix:/tmp/php-cgi.sock;
    server unix:/tmp/php-cgi2.sock;
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.5ã€æŠŠfastcgi_pass unix:/tmp/php-cgi.sock;æ”¹æˆ fastcgi_pass  backend;
é‡æ–°åŠ è½½
/etc/init.d/nginx reload&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ç»“è®ºï¼šè¿™ä¸ªæ–¹æ³•ï¼Œå’Œæˆ‘ç›´æ¥è°ƒå¤§php-fpm max_childrenå·®ä¸å¤šï¼Œä¸è€ƒè™‘ã€‚&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;3php-fpmçš„listenbacklogé»˜è®¤-1æ”¹ä¸º1024æˆ–è€…4096å³æ˜¯è°ƒå¤§&quot;&gt;3ã€php-fpmçš„listen.backlogé»˜è®¤-1æ”¹ä¸º1024æˆ–è€…4096ï¼Œå³æ˜¯è°ƒå¤§&lt;/h3&gt;
&lt;p&gt;Vå‹:onepunchå›å¤ï¼Œæ•´ç†å¦‚ä¸‹&lt;/p&gt;

&lt;h4 id=&quot;è°ƒæŸ¥&quot;&gt;è°ƒæŸ¥&lt;/h4&gt;
&lt;p&gt;nginx (å®¢æˆ·ç«¯) å’Œ php-fpm ï¼ˆæœåŠ¡ç«¯ï¼‰ é€šè¿‡ unix socket é€šä¿¡ï¼Œåœ¨ connet() æ—¶ï¼Œä¼šè¿›è¡Œç±»ä¼¼ tcp çš„ä¸‰æ¬¡æ¡æ‰‹,
å¦‚æœ accpet queue é˜Ÿåˆ—æ»¡äº†ï¼Œserver å°†å‘é€ä¸€ä¸ª ECONNREFUSED é”™è¯¯ä¿¡æ¯ Connection refused åˆ° clientã€‚
è¿™æ · nginx å°±ä¼šæŠ¥è¿™ä¸ªé”™äº†ï¼Œè¿æ¥ä¸ä¸Šã€‚php-fpm çš„ backlog æ˜¯ accpet queue çš„æœ€å¤§é•¿åº¦&lt;/p&gt;

&lt;p&gt;æŸ¥çœ‹ç³»ç»Ÿå†…æ ¸çš„æœ€å¤§é•¿åº¦&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cat /proc/sys/net/core/somaxconn 128
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æŸ¥çœ‹ php-fpm é‡Œçš„é…ç½® listen.backlog æ˜¯ 4096ï¼Œç”±äºä¼šå–è¿™ 2 ä¸ªçš„æœ€å°å€¼ï¼Œ æ‰€ä»¥æ˜¯ 128ã€‚&lt;/p&gt;

&lt;p&gt;éªŒè¯å½“æ—¶çš„è¯·æ±‚ï¼š&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;grep '2019-12-06T16:48' bi_svc.access.log.1 | wc -l //9903
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è®¡ç®—9903/60ç­‰äºæ¯ç§’è¯·æ±‚æ•°165ï¼Œ165&amp;gt;128 äº†, è¯·æ±‚å¤ªå¤šäº†ï¼Œåº”è¯¥æ˜¯ accpet queue æ»¡äº†&lt;/p&gt;

&lt;h4 id=&quot;è§£å†³åŠæ³•&quot;&gt;è§£å†³åŠæ³•&lt;/h4&gt;
&lt;p&gt;vi /etc/sysctl.conf&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;net.core.somaxconn = 1024
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;å°† /proc/sys/net/core/somaxconn æ”¹æˆ 1024 å°±ä¸ä¼šå‡ºé—®é¢˜äº†&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ç»“è®ºï¼šè¿™ä¸ªæ–¹æ³•æ˜¯ç¨³å®šPVæå‡ã€IOæå‡çš„è§£å†³æ–¹æ¡ˆï¼Œä¸è¿‡æˆ‘è¿™è¾¹é‡åˆ°çš„æ˜¯çªç„¶çš„æå‡ï¼Œæ‰€ä»¥æˆ‘è¿™è¾¹ä¸ä¼šè¿™æ ·å­åš&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&quot;æ›´å¤šæœåŠ¡å™¨ä¿¡æ¯&quot;&gt;æ›´å¤šæœåŠ¡å™¨ä¿¡æ¯&lt;/h2&gt;
&lt;h3 id=&quot;1äº‘æœåŠ¡å™¨ecs&quot;&gt;1ã€äº‘æœåŠ¡å™¨ECS&lt;/h3&gt;
&lt;p&gt;1.1ã€ç³»ç»Ÿç£ç›˜BPSï¼Œå…¶ä»–ç›‘æ§å†…å®¹æ— å¤ªå¤§çš„å¼‚å¸¸
&lt;img src=&quot;http://img.zzhpeng.cn/Fuk7Hg7v9LETTlt6lJIe7EcKeLoD&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;2rdsæ•°æ®åº“&quot;&gt;2ã€RDSæ•°æ®åº“&lt;/h3&gt;
&lt;p&gt;2.1ã€-ç½‘ç»œæµé‡
&lt;img src=&quot;http://img.zzhpeng.cn/Fo5pktGwx-j4lERPURRBcVnQekPA&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;p&gt;2.2ã€RDSæ•°æ®åº“-CPUä½¿ç”¨ç‡
&lt;img src=&quot;http://img.zzhpeng.cn/Fs_A1vSJ9M5MrVF9dLMktQ6vq5u5&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;p&gt;2.3ã€RDSæ•°æ®åº“-TPS/QPS
&lt;img src=&quot;http://img.zzhpeng.cn/FuCeHHk2YnWJkzsfGBEHQGp2MhAc&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;p&gt;2.4ã€RDSæ•°æ®åº“-æ…¢æ—¥å¿—
&lt;img src=&quot;http://img.zzhpeng.cn/FsSPL2M079cfnmeqN7LmX7-wE3lo&quot; alt=&quot;FilqyanVhrxGwgOxksnDlyWAnw-W&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;æœ€åé€‰æ‹©&quot;&gt;æœ€åé€‰æ‹©&lt;/h2&gt;
&lt;p&gt;ç”¨æˆ·è¯·æ±‚é£™å‡ï¼Œå¹³å°åˆæ²¡æœ‰åšä»€ä¹ˆæ´»åŠ¨ï¼ŒæŸ¥çœ‹äº†nginx access logï¼Œåˆ†æåŒä¸€ä¸ªipï¼ŒåŒä¸€æ—¶é—´æ®µä¸Šç™¾ä¸ªè¯·æ±‚åŒ
ä¸€ä¸ªè®¿é—®é“¾æ¥ï¼Œæ‰€ä»¥å†³å®šiptableé™åˆ¶ä¸‹ï¼Œæ§åˆ¶å•ä¸ªIPçš„æœ€å¤§30å¹¶å‘è¿æ¥æ•°ã€‚&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -I INPUT -p tcp --dport 443 -m connlimit --connlimit-above 30 -j REJECT
sudo iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 30 -j REJECT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;åç»­&quot;&gt;åç»­&lt;/h2&gt;
&lt;p&gt;é—®é¢˜è¿˜æ˜¯å‡ºç°äº†ï¼ŒæŸ¥çœ‹ä¸‹ä¸€ç¯‡post&lt;/p&gt;

&lt;h2 id=&quot;è¿­ä»£&quot;&gt;è¿­ä»£&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;2019å¹´12æœˆ27æ—¥ 15:29:00 åˆç¨¿&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;å‚è€ƒ&quot;&gt;å‚è€ƒ&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.v2ex.com/t/632647&quot;&gt;nginx+ PHP -fpm å‡ºç° 502&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://blog.csdn.net/chengxuyuanyonghu/article/details/54409523&quot;&gt;iptablesé™åˆ¶åŒä¸€IPè¿æ¥æ•°&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/lilidun/p/5801437.html&quot;&gt;centos 7 iptablesåŸºæœ¬é…ç½®&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Thu, 26 Dec 2019 00:00:00 +0800</pubDate>
				<link>/nginx502_2.html</link>
				<guid isPermaLink="true">/nginx502_2.html</guid>
			</item>
		
			<item>
				<title>ç”Ÿäº§ç¯å¢ƒå‡ºç°nginx502,å¯¼è‡´åæ¥åˆ†é’Ÿç³»ç»Ÿå¥”æºƒï¼ˆTp5.1çš„session bugï¼‰</title>
				<description>&lt;h2 id=&quot;é—®é¢˜æ¦‚è¿°&quot;&gt;é—®é¢˜æ¦‚è¿°&lt;/h2&gt;
&lt;p&gt;ä½¿ç”¨PHPçš„ThinkPHP5.1å¼€å‘æ¡†æ¶ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨å®å¡”ç®¡ç†ï¼Œå…¶ä¸­nginxç›´æ¥æŠ¥é”™502ï¼Œç»§ç»­æ—¶é—´10æ¥åˆ†é’Ÿã€‚è€Œä¸”é€šè¿‡è§‚å¯Ÿï¼Œä¸€æ®µæ—¶é—´åˆä¼šå‡ºç°ï¼Œç‰¹åˆ«æ˜¯å¤æ‚é¢‘ç¹çš„æ“ä½œã€‚&lt;/p&gt;

&lt;h2 id=&quot;æ’æŸ¥æ•°æ®&quot;&gt;æ’æŸ¥æ•°æ®&lt;/h2&gt;
&lt;p&gt;nginxæŠ›å‡º502,è¯æ˜æ˜¯å®ƒçš„åå‘ä»£ç†å‡ºé”™ï¼Œè¿™ä¸ªä»£ç†php-cgiæŒ‚æ‰äº†ï¼Œæˆ‘ç”¨çš„æ˜¯php-fpmï¼Œå‡ºäº†é—®é¢˜ã€‚åœ¨å®å¡”é»˜è®¤php-fpmé…ç½®æœ‰è®¾ç½®æ—¥å¿—è¾“å‡º&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[global]
error_log = /www/server/php/72/var/log/php-fpm.log
[www]
slowlog = var/log/slow.log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;php-fpm-é…ç½®&quot;&gt;php-fpm é…ç½®&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[global]
pid = /www/server/php/72/var/run/php-fpm.pid
error_log = /www/server/php/72/var/log/php-fpm.log
log_level = notice

[www]
listen = /tmp/php-cgi-72.sock
listen.backlog = -1
listen.allowed_clients = 127.0.0.1
listen.owner = www
listen.group = www
listen.mode = 0666
user = www
group = www
pm = dynamic
pm.status_path = /phpfpm_72_status
pm.max_children = 150
pm.start_servers = 30
pm.min_spare_servers = 30
pm.max_spare_servers = 150
request_terminate_timeout = 100
request_slowlog_timeout = 30
slowlog = var/log/slow.log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;æœºå™¨é…ç½®é˜¿é‡Œäº‘4 vCPU 8 GiB ( å…±äº«è®¡ç®—å‹ n1, ecs.n1.large )ï¼Œ&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;æŸ¥çœ‹php-fpmlog-éƒ¨åˆ†å†…å®¹&quot;&gt;æŸ¥çœ‹php-fpm.log éƒ¨åˆ†å†…å®¹&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/Fu0ZUUtbHNQ0b4nh7d2QN4_LJvtB&quot; alt=&quot;Fu0ZUUtbHNQ0b4nh7d2QN4_LJvtB&quot; /&gt;&lt;/p&gt;

&lt;p&gt;è¿™å¼ å›¾æ˜¾ç¤ºï¼Œæœ‰ä¸¤éƒ¨åˆ†å†…å®¹ï¼š&lt;/p&gt;

&lt;p&gt;1ã€php-fpm workerè¿›ç¨‹ç”±äºå¤„ç†çš„ç¨‹åºè¶…è¿‡109så·¦å³(ç¯å¢ƒrequest_terminate_timeout = 100)ï¼Œè¿›ç¨‹å‘å‡ºçš„signal 15(SIGTERM)ã€‚
å¯¹äºsignal 15(SIGTERM) çš„ SIGTERMï¼ŒæŸ¥é˜…äº†ä¸‹ï¼Œæ˜¯è¯´ï¼šç³»ç»Ÿä¼šå‘é€ä¸€ä¸ªSIGTERMçš„ä¿¡å·ç»™å¯¹åº”çš„ç¨‹åºã€‚
å½“ç¨‹åºæ¥æ”¶åˆ°è¯¥signalåï¼Œå°†ä¼šå‘ç”Ÿä»¥ä¸‹çš„äº‹æƒ…ï¼š&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;1ã€ç¨‹åºç«‹åˆ»åœæ­¢&lt;/li&gt;
  &lt;li&gt;2ã€è¯¥ç¨‹åºé‡Šæ”¾ç›¸åº”èµ„æºåå†åœæ­¢&lt;/li&gt;
  &lt;li&gt;3ã€ç¨‹åºå¯èƒ½ä»ç„¶ç»§ç»­è¿è¡Œ&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å¤§éƒ¨åˆ†ç¨‹åºæ¥æ”¶åˆ°SIGTERMä¿¡å·åï¼Œä¼šå…ˆé‡Šæ”¾è‡ªå·±çš„èµ„æºï¼Œç„¶ååœ¨åœæ­¢ã€‚ä½†æ˜¯ä¹Ÿæœ‰ç¨‹åºå¯ä»¥åœ¨æ¥å—åˆ°ä¿¡å·é‡åï¼Œåšä¸€äº›å…¶ä»–çš„äº‹æƒ…ï¼Œ
å¹¶ä¸”è¿™äº›äº‹æƒ…æ˜¯å¯ä»¥é…ç½®çš„ã€‚å¦‚æœç¨‹åºæ­£åœ¨ç­‰å¾…IOï¼Œå¯èƒ½å°±ä¸ä¼šç«‹é©¬åšå‡ºå“åº”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒSIGTERMå¤šåŠæ˜¯ä¼šè¢«é˜»å¡çš„ã€å¿½ç•¥ã€‚&lt;/p&gt;

&lt;p&gt;2ã€å¸¦æœ‰è¯·æ±‚çš„å…·ä½“é“¾æ¥ï¼Œæ˜¾ç¤ºè¯·æ±‚å¤ªæ…¢ï¼Œè¶…è¿‡äº†39s(request_slowlog_timeout = 30),è®°å½•äº†logã€‚&lt;/p&gt;

&lt;h3 id=&quot;æŸ¥çœ‹slowlog-éƒ¨åˆ†å†…å®¹&quot;&gt;æŸ¥çœ‹slow.log éƒ¨åˆ†å†…å®¹&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FnNWSnsLDg0mjBKt2x4ARGIBrlk6&quot; alt=&quot;Fu0ZUUtbHNQ0b4nh7d2QN4_LJvtB&quot; /&gt;&lt;/p&gt;

&lt;p&gt;è¿™å¼ å›¾æ˜¾ç¤ºï¼Œè¯·æ±‚å¤„ç†åªåˆ°äº†æ¡†æ¶åˆå§‹ä»£ç å’Œæƒé™éªŒè¯é‚£å—ï¼Œå¹¶æ²¡ç”¨å®é™…åˆ°è¾¾ä¸šåŠ¡ä»£ç ç¨‹åºã€‚å¯æ’é™¤sqlæ…¢æŸ¥è¯¢æˆ–è€…
ä¸šåŠ¡ä»£ç é—®é¢˜ã€‚&lt;/p&gt;

&lt;h3 id=&quot;æŸ¥çœ‹æ¡†æ¶çš„tp51-log-éƒ¨åˆ†å†…å®¹&quot;&gt;æŸ¥çœ‹æ¡†æ¶çš„TP5.1 log éƒ¨åˆ†å†…å®¹&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FjPr7FPhs1lf91PR__DOZIN6ZRzO&quot; alt=&quot;Fu0ZUUtbHNQ0b4nh7d2QN4_LJvtB&quot; /&gt;&lt;/p&gt;

&lt;p&gt;è¿™å¼ å›¾æ˜¾ç¤ºï¼Œè¯·æ±‚å¤„ç†è¿˜æ²¡åˆ°csrféªŒè¯å±‚å°±é˜»å¡äº†!!!&lt;/p&gt;

&lt;h3 id=&quot;é¢æ¿è¿›ç¨‹æƒ…å†µ&quot;&gt;é¢æ¿è¿›ç¨‹æƒ…å†µ&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FnfJPvsSClmAGAbKGbCP2bhcVLI7&quot; alt=&quot;FnfJPvsSClmAGAbKGbCP2bhcVLI7&quot; /&gt;&lt;/p&gt;

&lt;p&gt;è¿™å¼ å›¾æ˜¾ç¤ºæ˜¯é‚£ä¸ªæ—¶é—´æ®µæŠ›å‡º502å®•æœº10æ¥åˆ†é’Ÿphp-fpmè®°å½•ä¸‹æ¥çš„statusã€‚æ•°æ®æ˜¾ç¤ºï¼Œè¯·æ±‚æ•°é‡æœ‰53441,ä½†æ˜¯æ´»è·ƒè¿›ç¨‹æ•°åªæœ‰1ä¸ªï¼Œ
å¹¶ä¸”äº§ç”Ÿäº†450ä¸ªæ…¢æŸ¥è¯¢æ•°é‡ã€‚&lt;/p&gt;

&lt;h3 id=&quot;session-é˜»å¡&quot;&gt;Session é˜»å¡&lt;/h3&gt;
&lt;p&gt;æ—¢ç„¶ä¸æ˜¯æ…¢SQLäº§ç”Ÿçš„é—®é¢˜ï¼Œå¹¶ä¸”æœ‰å¤§é‡è¯·æ±‚æ²¡æœ‰è¾¾åˆ°crsféªŒè¯å±‚ï¼Œåªåˆ°è¾¾äº†crsfå±‚ä¸Šé¢çš„æƒé™éªŒè¯å±‚ï¼Œæƒé™åˆæ˜¯åŸºäºcookieså’Œsessionçš„ï¼Œé‚£å°±æ¨æ–­æ˜¯sessioné˜»å¡å¼•èµ·çš„ã€‚
ä»€ä¹ˆä¼šå¼•èµ·sessioné˜»å¡å‘¢ï¼ŸæŸ¥é˜…äº†èµ„æ–™ï¼Œå¹¶å†™ä¸‹é¢ä»£ç åœ¨æœ¬åœ°æµ‹è¯•ã€‚&lt;/p&gt;

&lt;p&gt;å‰ç«¯js codeï¼ˆä¸‰ä¸ªè¯·æ±‚ajax1ã€ajax2ã€ajax3åŒæ—¶è¿›è¡Œï¼‰&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;script src=&quot;https://cdn.bootcss.com/jquery/3.4.0/jquery.js&quot;&amp;gt;&amp;lt;/script&amp;gt;
&amp;lt;script&amp;gt;
    var a = 1;
    var b = 1;
    var c = 1;
    function ajax1(){
        $.get('/hello?from=a', function(){
            console.log('a' , a);
            a++;
            ajax1();
        });
    }
    function ajax2(){
        $.get('/hello?from=b', function(){
            console.log('b',b);
            b++;
            ajax2();
        });
    }
    function ajax3(){
        $.get('/hello?from=c', function(){
            console.log('c',c);
            c++;
            ajax3();
        });
    }

    function beginAjax(){
        ajax1();
        ajax2();
        ajax3();
    }
    beginAjax();
&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;TP5.1åç«¯code&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;app\index\controller&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;think\Controller&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Index&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Controller&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;hello&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'ThinkPHP5'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'qanda'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'1'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//sessionæ˜¯tp5.1çš„å®šä¹‰çš„æ–¹æ³•&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;sleep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'data'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;session_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()]);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;php-fpm.confé…ç½®&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;request_slowlog_timeout = 16
request_terminate_timeout = 20
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;ç«ç‹æµè§ˆå™¨&quot;&gt;ç«ç‹æµè§ˆå™¨&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/Fi30BAxREfNBpYLRLMXJrS_vCzop&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;ç«ç‹æµè§ˆå™¨æµ‹è¯•ï¼Œå¶å°”ä¼šå‡ºç°åˆšå¼€å§‹è¿”å›çš„session_idä¸ä¸€è‡´é—®é¢˜åŒæ—¶å“åº”çš„æ—¶é—´a,b,cä¸‰ä¸ªä¸ä¸€æ ·å‚æ•°è¯·æ±‚å“åº”éƒ½åœ¨5så¤šä¸€ç‚¹ï¼Œ
ä¸è¿‡åé¢è¿”å›çš„session_idå°±ä¸€è‡´äº†ï¼ŒåŒæ—¶å“åº”çš„æ—¶é—´ä¹Ÿå˜ä¸ºäº†15s+äº†ã€‚&lt;/p&gt;

&lt;h3 id=&quot;chromeæµè§ˆå™¨&quot;&gt;chromeæµè§ˆå™¨&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/FvVEgokNtB95OjJRUcH21E2BCvCY&quot; alt=&quot;&quot; /&gt;
chromeæµè§ˆå™¨åˆšå¼€å§‹è¿”å›çš„session_idå°±ä¸€è‡´ï¼Œä½†æ˜¯è€—æ—¶è¾ƒé•¿ï¼Œåé¢è¶‹äºç¨³å®šçš„15s+ã€‚&lt;/p&gt;

&lt;h3 id=&quot;å°†æµ‹è¯•codeæ”¾åˆ°laravel62æµ‹è¯•&quot;&gt;å°†æµ‹è¯•codeæ”¾åˆ°Laravel6.2æµ‹è¯•ã€‚&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://img.zzhpeng.cn/Fn6BmTtjJNXJgOyGdGe74yt10cpd&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;ç¨³å®šè¾“å‡º5s+ï¼Œé‚£å°±æ˜¯TP5.1çš„sessionå‡ºç°bugäº†ï¼ï¼ï¼&lt;/p&gt;

&lt;h3 id=&quot;tp51çš„sessionä¸ºä»€ä¹ˆä¼šå‡ºç°é—®é¢˜&quot;&gt;TP5.1çš„Sessionä¸ºä»€ä¹ˆä¼šå‡ºç°é—®é¢˜&lt;/h3&gt;
&lt;p&gt;Sessioné˜»å¡çš„åŸå› ç½‘ä¸Šå¤§éƒ¨åˆ†è¯´æ˜¯session_start(),ä½¿ç”¨å®Œè®°å¾—session_write_close()ã€‚éš¾é“TP5.1ä½¿ç”¨äº†åæ²¡close???
æŸ¥çœ‹TP5.1æºç ï¼š&lt;/p&gt;

&lt;p&gt;1ã€
&lt;img src=&quot;http://img.zzhpeng.cn/FqC_5ivD1cFKjx2A06w6gALb4pzo&quot; alt=&quot;&quot; /&gt;
2ã€
&lt;img src=&quot;http://img.zzhpeng.cn/FsD9JQa5VlMSAhK-ijYmwEMx0t01&quot; alt=&quot;&quot; /&gt;
3ã€
&lt;img src=&quot;http://img.zzhpeng.cn/FjgcLLdJglPrpHiWnnbjfIyQMit2&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;è¿˜çœŸæ˜¯TP5.1æ²¡closeï¼Œè¿™bugå°±å¾ˆå®¹æ˜“è®©ç³»ç»Ÿå¤„äº502çŠ¶æ€ï¼Œç«Ÿç„¶æ²¡äººé‡åˆ°è¿‡å¹¶ä¸”ä¿®å¤å—ï¼Ÿåæ˜ å¹¶ä¸”æäº¤issueä¿®å¤ï¼çœ‹äº†ä¸‹æœ€æ–°çš„TP6,å€Ÿé‰´Laravelçš„Sessionã€Cookiesç»„ä»¶åŒ–äº†
TPçš„è¿™ä¸ªbugä¹Ÿå°±ä¸å­˜åœ¨äº†ã€‚&lt;/p&gt;

&lt;h2 id=&quot;è§£å†³&quot;&gt;è§£å†³&lt;/h2&gt;
&lt;p&gt;ç³»ç»Ÿè¿˜æ˜¯è¦ç”¨ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œç”¨TP5.1 sessioné”ï¼Œcode å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;return [
    'id'             =&amp;gt; '',
    // SESSION_IDçš„æäº¤å˜é‡,è§£å†³flashä¸Šä¼ è·¨åŸŸ
    'var_session_id' =&amp;gt; '',
    // SESSION å‰ç¼€
    'prefix'         =&amp;gt; 'think',
    // é©±åŠ¨æ–¹å¼ æ”¯æŒredis memcache memcached
    'type'           =&amp;gt; '',
    // æ˜¯å¦è‡ªåŠ¨å¼€å¯ SESSION
    'auto_start'     =&amp;gt; true,
    'use_lock'     =&amp;gt; true,
];
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ä¿®æ”¹åï¼Œå“åº”æ—¶é—´æ­£å¸¸äº†
&lt;img src=&quot;http://img.zzhpeng.cn/FiRwyQzfDp9ZYp8EzPCH6GCWXEb7&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;æ³¨æ„ä¸ç–‘æƒ‘&quot;&gt;æ³¨æ„ä¸ç–‘æƒ‘&lt;/h2&gt;
&lt;h3 id=&quot;æ³¨æ„&quot;&gt;æ³¨æ„&lt;/h3&gt;
&lt;p&gt;1ã€æŸ¥åˆ°èµ„æ–™çœ‹åˆ°ä¸æ˜¯ä»£ç çš„å¼•èµ·çš„502ï¼Œè€Œæ˜¯ç¯å¢ƒé…ç½®ã€‚
https://www.cnblogs.com/zenghansen/p/4647004.html&lt;/p&gt;

&lt;h3 id=&quot;ç–‘æƒ‘&quot;&gt;ç–‘æƒ‘&lt;/h3&gt;
&lt;p&gt;1ã€ä¸ºä»€ä¹ˆæ‰§è¡Œæ—¶é—´session_write_closeä¸æ‰§è¡Œï¼Œè¿”å›æ—¶é—´ä¼šç´¯åŠ å‘¢ï¼Ÿ&lt;/p&gt;

&lt;h2 id=&quot;å‚è€ƒ&quot;&gt;å‚è€ƒ&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;1ã€&lt;a href=&quot;https://www.cnblogs.com/skillCoding/archive/2012/04/09/2439296.html&quot;&gt;PHPçš„Sessioné˜»å¡é—®é¢˜æ¢è®¨&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;2ã€&lt;a href=&quot;https://www.cnblogs.com/yufeng218/p/9911368.html&quot;&gt;session å’Œ cookie&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;3ã€&lt;a href=&quot;https://blog.csdn.net/qq_26836575/article/details/82147558&quot;&gt;SIGKILLå’ŒSIGTERMã€SIGINT&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;4ã€&lt;a href=&quot;https://www.cnblogs.com/pheye/p/7890065.html&quot;&gt;å¦‚ä½•ç®¡ç†Session(é˜²æ­¢æ¶æ„å…±äº«è´¦å·)â€”â€”ç†è®ºç¯‡&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;5ã€&lt;a href=&quot;https://www.cnblogs.com/zenghansen/p/4647004.html&quot;&gt;nginxä¸‹phpé¢‘ç¹å¡æ­»502&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<pubDate>Mon, 25 Nov 2019 00:00:00 +0800</pubDate>
				<link>/nginx502_1.html</link>
				<guid isPermaLink="true">/nginx502_1.html</guid>
			</item>
		
			<item>
				<title>Redisçš„åŸå­æ€§è§£å†³å¹¶å‘é—®é¢˜</title>
				<description>&lt;h3 id=&quot;é—®é¢˜æ¦‚è¿°&quot;&gt;é—®é¢˜æ¦‚è¿°&lt;/h3&gt;

&lt;p&gt;æœ€è¿‘æ ¹æ®è¿è¥é‚£è¾¹æä¾›BUGåé¦ˆä¿¡æ¯æç¤ºï¼Œå‡ºç°äº†ä»“åº“å•†å“å†»ç»“æ•°é‡å°‘äº†ï¼Œå¯¼è‡´å‡ºåº“å¼‚å¸¸ç°è±¡ã€‚ä»“åº“å•†å“åº“å­˜ä¿¡æ¯
è¡¨è®¾è®¡æ˜¯åº“å­˜numï¼Œå†»ç»“æ•°frozen_numã€‚å½“ä¸‹è®¢å•çš„æ—¶å€™ï¼Œfrozen_num + 1ã€‚è®¢å•ç»“æŸï¼Œå•†å“åº“å­˜num - 
å‡ºåº“æ•°é‡ï¼Œå†»ç»“æ•°frozen_num - å‡ºåº“æ•°é‡ã€‚ä½†æ˜¯åœ¨é«˜å¹¶å‘ä¸‹ï¼Œå¤šä¸ªè¯·æ±‚åŒæ—¶è¿›æ¥ï¼Œè®¢å•ä¸‹äº†å¤šä¸ªï¼Œfrozen_numåªåŠ äº†1ï¼Œé‚£æ ·å‡ºåº“çš„æ—¶å€™å°±ä¼šäº§ç”Ÿå¼‚å¸¸ã€‚&lt;/p&gt;

&lt;h3 id=&quot;åˆæ­¥æ–¹æ¡ˆé€‰æ‹©åˆ©ç”¨redisçš„åŸå­æ€§å®ç°é”&quot;&gt;åˆæ­¥æ–¹æ¡ˆé€‰æ‹©ï¼Œåˆ©ç”¨redisçš„åŸå­æ€§ï¼Œå®ç°é”&lt;/h3&gt;
&lt;blockquote&gt;
  &lt;p&gt;1ã€Redis SETNX&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Redis SETNXçš„ç”¨æ³•æ˜¯SETNX key valueã€‚è€Œè¿”å›å€¼ï¼Œå¦‚æœè®¾ç½®keyæˆåŠŸä¼šè¿”å›1ï¼Œæ²¡æœ‰è¢«è®¾ç½®ä¼šè¿”å›0ã€‚
ç®€å•è¯´å°±æ˜¯SET if Not eXistsï¼Œä¸å­˜åœ¨å°±å¯ä»¥è¢«è®¾ç½®ã€‚&lt;/p&gt;

&lt;p&gt;ç„¶åæ ¹æ®è¿™ä¸ªç‰¹æ€§ï¼Œç”¨SETNXçš„valueè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œç»“åˆRedis DEL key [key â€¦]ï¼Œç”¨è¿‡æœŸæ—¶é—´å’Œç¨‹åº
æ˜¯å¦æ‰§è¡Œå®Œæˆï¼Œå»åˆ¤æ–­æ˜¯å¦å¯ä»¥åˆ é™¤è¿™ä¸ªkeyæ¥å®ç°åŸå­æ€§æ§åˆ¶ã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;if è·å–é”æˆåŠŸ
    1ã€æ‰§è¡Œç¨‹åº
    2ã€è§£é”
else 
    //è·å–é”å¤±è´¥ï¼Œåˆ¤æ–­è¿‡æœŸæ—¶é—´
    if è¿‡æœŸå¹¶ä¸”è¶…æ—¶ï¼Œ
        1ã€è§£é”
    if å†æ¬¡è·å–é”
        1.æ‰§è¡Œç¨‹åº
        2ã€è§£é”   
    else
        ä¸å¤„ç†ï¼Œè¯·æ±‚ç»“æŸ
}

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è·å–é”å¤±è´¥ï¼Œåˆ¤æ–­valueè¿™ä¸ªè¿‡æœŸæ—¶é—´è§£é”å¾ˆå¥½çš„è§£å†³äº†è¿›ç¨‹å¼‚å¸¸è§£é”ç¨‹åºä¸æ‰§è¡Œäº§ç”Ÿæ­»é”é—®é¢˜ï¼Œä½†æ˜¯ç¨‹åºè§£é”å†è·å–é”çš„è¿‡ç¨‹
æ˜¯éåŸå­æ€§çš„ï¼Œæ‰€ä»¥ä¼šå­˜åœ¨æç«¯ç°è±¡ï¼Œå‡è®¾æœ‰è¿›ç¨‹P1ã€P2ï¼Œä¼šå‡ºç°å¦‚ä¸‹æƒ…å†µã€‚&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;1ã€P1å’ŒP2éƒ½è·å–é”å¤±è´¥ï¼ŒåŒæ—¶è¿›è¡Œè¿‡æœŸåˆ¤æ–­ï¼Œå¹¶ä¸”éƒ½é€šè¿‡ã€‚&lt;/li&gt;
  &lt;li&gt;2ã€P1è§£é”æˆåŠŸï¼Œå†è·å–é”ã€‚&lt;/li&gt;
  &lt;li&gt;3ã€P2åˆè§£é”æˆåŠŸï¼Œä¹Ÿè·å–äº†é”ã€‚&lt;/li&gt;
  &lt;li&gt;4ã€P1ã€P2åŒæ—¶è·å–é”æˆåŠŸã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä¸è¿‡å®˜æ–¹ç»™äº†æ›¿æ¢æ–¹æ¡ˆï¼ŒåŸè¯ä¸º&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Anyway even assuming a single-instance locking primitive, starting with 2.6.12
it is possible to create a much simpler locking primitive, equivalent to the 
one discussed here, using the SET command to acquire the lock, and a simple 
Lua script to release the lock. The pattern is documented in the SET command 
page.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è¡¨è¾¾çš„å°±æ˜¯ä»redis 2.6.12ç‰ˆæœ¬èµ·,å¯ä»¥ç”¨setå®ç°setnxåŠŸèƒ½å¹¶ä¸”å¯ä»¥è®¾ç½®é”è¿‡æœŸæ—¶é—´å’ŒåŸå­æ€§è¯­è¨€çš„luaè„šæœ¬é‡Šæ”¾é”ï¼Œå»æ›¿æ¢äº†setnxã€‚&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;2ã€Redis SET&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ç”¨äº†setä¹‹åç¨‹åºå°±ä¸ç”¨å»åˆ¤æ–­æ˜¯å¦è¿‡æœŸå»ç¨‹åºè§£é”äº†ï¼Œä¹Ÿå®ç°äº†åŸå­æ€§ã€‚ä¼ªä»£ç å˜ä¸ºï¼š&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;if è·å–é”æˆåŠŸ
    1ã€æ‰§è¡Œç¨‹åº
    2ã€è§£é”
else 
    //è·å–é”å¤±è´¥
    1ã€ä¸å¤„ç†
}

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;æ¼”ç¤ºä»£ç &quot;&gt;æ¼”ç¤ºä»£ç &lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;æ•°æ®åº“&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;è®¢å•è¡¨&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;DROP TABLE IF EXISTS `order`;
CREATE TABLE `order` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `num` int(11) NOT NULL DEFAULT '0' COMMENT 'é”€å”®å•†å“æ•°é‡',
  `store_depot_batch_id` int(11) NOT NULL COMMENT 'é—¨åº—ä»“åº“æ‰¹æ¬¡id',
  `create_time` timestamp NULL DEFAULT NULL COMMENT 'æ·»åŠ æ—¶é—´ï¼Œ',
  `update_time` timestamp NULL DEFAULT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  `delete_time` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='è®¢å•è¡¨';

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;é—¨åº—ä»“åº“æ‰¹æ¬¡è¡¨&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;DROP TABLE IF EXISTS `depot_store_depot_batch`;
CREATE TABLE `depot_store_depot_batch` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `num` int(11) NOT NULL DEFAULT '0' COMMENT 'æ€»æ•°é‡ï¼Œæœ‰æ•ˆæ•°é‡=æ€»æ•°-å†»ç»“æ•°é‡',
  `frozen_num` int(11) NOT NULL DEFAULT '0' COMMENT 'å†»ç»“æ•°é‡',
  `create_time` timestamp NULL DEFAULT NULL COMMENT 'æ·»åŠ æ—¶é—´ï¼Œå…¥åº“æ—¶é—´',
  `update_time` timestamp NULL DEFAULT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  `delete_time` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='é—¨åº—ä»“åº“æ‰¹æ¬¡ç®¡ç†';

INSERT INTO `depot_store_depot_batch` VALUES(1,10,0,NOW(),NOW(),NULL);

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;é—¨åº—ä»“åº“æ‰¹æ¬¡å†»ç»“æ“ä½œè¡¨&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;DROP TABLE IF EXISTS `depot_store_depot_batch_frozen_record`;
CREATE TABLE `depot_store_depot_batch_frozen_record` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `depot_store_depot_batch_id` int(11) NOT NULL COMMENT 'é—¨åº—ä»“åº“æ‰¹æ¬¡ç®¡ç†id',
  `before_frozen_num` int(11) NOT NULL COMMENT 'ä»“åº“å†»ç»“æ•°é‡å˜åŠ¨å‰',
  `after_frozen_num` int(11) NOT NULL COMMENT 'ä»“åº“å†»ç»“æ•°é‡å˜åŠ¨å',
  `frozen_num` int(11) DEFAULT '0',
  `desc` varchar(100) NOT NULL COMMENT 'æè¿°',
  `create_time` timestamp NULL DEFAULT NULL COMMENT 'æ·»åŠ æ—¶é—´',
  `update_time` timestamp NULL DEFAULT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='é—¨åº—ä»“åº“å†»ç»“è®°å½•';

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;ä»£ç ï¼Œå®ç°ä¸‹å•ã€æ›´æ–°ä»“åº“å†»ç»“æ•°å’Œæ·»åŠ å†»ç»“æ“ä½œè®°å½•&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h4 id=&quot;æ²¡æœ‰åŠ redisé”çš„ä»£ç &quot;&gt;æ²¡æœ‰åŠ redisé”çš„ä»£ç &lt;/h4&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;sd&quot;&gt;/**
 * Created by PhpStorm.
 * User: zzhpeng
 * Date: 2019/11/2
 * Time: 11:32 AM
 */&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;PDO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'mysql:host=127.0.0.1;dbname=store'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'root'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'123456789'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;//é”€å”®æ•°é‡&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_GET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;??&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//æŸ¥è¯¢é—¨åº—ä»“åº“æ‰¹æ¬¡ä¿¡æ¯&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchSql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;select * from  `depot_store_depot_batch` where id =1 limit 1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//æ“ä½œåå†»ç»“æ•°é‡&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'frozen_num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$activeNumber&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//å¼€å¯äº‹åŠ¡&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;beginTransaction&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$activeNumber&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'å•†å“å·²å”®ç½„äº†'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//ä¸‹å•ä¸»è¡¨&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$orderSql&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;insert into `order` VALUES (null,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,1,NOW(),NOW(),null)&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$orderSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$orderId&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lastInsertId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$orderId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchUpdateSql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;update `depot_store_depot_batch` set `frozen_num`=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; WHERE id=1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchUpdateSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;//å†»ç»“è®°å½•æ“ä½œsql&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$actionSql&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;insert into `depot_store_depot_batch_frozen_record` VALUES (null,1,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'frozen_num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,'å¹¶å‘æµ‹è¯•',NOW(),NOW())&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$actionSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;//æäº¤äº‹åŠ¡&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;commit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'ä¸‹å•æˆåŠŸ,è®¢å•idä¸º'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$orderId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;\Exception&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//å›æ»šäº‹åŠ¡&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;rollBack&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getMessage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;abå‹åŠ›æµ‹è¯•ï¼Œab -n 100 -c 10 http://127.0.0.1:83/redis.php,ç„¶åæŸ¥çœ‹ä¸‰ä¸ªè¡¨mysqlè®°å½•ã€‚&lt;/p&gt;

&lt;p&gt;æŸ¥çœ‹Orderè¡¨æƒ…å†µï¼Œæ˜¾ç¤ºäº†35row orderã€‚&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select * from `order`;
+----+-----+----------------------+---------------------+---------------------+-------------+
| id | num | store_depot_batch_id | create_time         | update_time         | delete_time |
+----+-----+----------------------+---------------------+---------------------+-------------+
|  1 |   1 |                    1 | 2019-11-03 19:08:06 | 2019-11-03 19:08:06 | NULL        |
|  2 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  3 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  4 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  5 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  6 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  7 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  8 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
|  9 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 10 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 11 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 12 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 13 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 14 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 15 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 16 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 17 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 18 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 19 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 20 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 21 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 22 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 23 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 24 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 25 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 26 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 27 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 28 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 29 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 30 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 31 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 32 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 33 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 34 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
| 35 |   1 |                    1 | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 | NULL        |
+----+-----+----------------------+---------------------+---------------------+-------------+
35 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;æŸ¥çœ‹depot_store_depot_batchè¡¨æƒ…å†µï¼Œç¡®å®å†»ç»“äº†10ä¸ªã€‚&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select * from `depot_store_depot_batch`;
+----+-----+------------+---------------------+---------------------+-------------+
| id | num | frozen_num | create_time         | update_time         | delete_time |
+----+-----+------------+---------------------+---------------------+-------------+
|  1 |  10 |         10 | 2019-11-03 19:06:59 | 2019-11-03 19:06:59 | NULL        |
+----+-----+------------+---------------------+---------------------+-------------+
1 row in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æŸ¥çœ‹depot_store_depot_batch_frozen_recordè¡¨æƒ…å†µï¼Œ35rowè®°å½•ã€‚&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select * from depot_store_depot_batch_frozen_record;
+------+----------------------------+-------------------+------------------+------------+------+---------------------+---------------------+
| id   | depot_store_depot_batch_id | before_frozen_num | after_frozen_num | frozen_num | desc | create_time         | update_time         |
+------+----------------------------+-------------------+------------------+------------+------+---------------------+---------------------+
| 2342 |                          1 |                 0 |                1 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2343 |                          1 |                 1 |                2 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2344 |                          1 |                 1 |                2 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2345 |                          1 |                 1 |                2 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2346 |                          1 |                 1 |                2 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2347 |                          1 |                 1 |                2 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2348 |                          1 |                 2 |                3 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2349 |                          1 |                 2 |                3 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2350 |                          1 |                 2 |                3 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2351 |                          1 |                 2 |                3 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2352 |                          1 |                 2 |                3 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2353 |                          1 |                 3 |                4 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2354 |                          1 |                 3 |                4 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2355 |                          1 |                 3 |                4 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2356 |                          1 |                 3 |                4 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2357 |                          1 |                 4 |                5 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2358 |                          1 |                 4 |                5 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2359 |                          1 |                 4 |                5 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2360 |                          1 |                 4 |                5 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2361 |                          1 |                 5 |                6 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2362 |                          1 |                 5 |                6 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2363 |                          1 |                 5 |                6 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2364 |                          1 |                 5 |                6 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2365 |                          1 |                 5 |                6 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2366 |                          1 |                 6 |                7 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2367 |                          1 |                 6 |                7 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2368 |                          1 |                 6 |                7 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2369 |                          1 |                 7 |                8 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2370 |                          1 |                 7 |                8 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2371 |                          1 |                 7 |                8 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2372 |                          1 |                 8 |                9 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2373 |                          1 |                 8 |                9 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2374 |                          1 |                 8 |                9 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2375 |                          1 |                 9 |               10 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
| 2376 |                          1 |                 9 |               10 |          1 | ???? | 2019-11-03 19:08:07 | 2019-11-03 19:08:07 |
+------+----------------------------+-------------------+------------------+------------+------+---------------------+---------------------+
35 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;ç»“è®ºå°±æ˜¯ï¼Œè™½ç„¶å†»ç»“æ•°æ˜¯å¯¹äº†ï¼Œä½†æ˜¯å‡ºäº†å¾ˆå¤šè¶…å–çš„è®¢å•&lt;/strong&gt;&lt;/p&gt;

&lt;h4 id=&quot;åŠ redisé”çš„ä»£ç &quot;&gt;åŠ redisé”çš„ä»£ç &lt;/h4&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;sd&quot;&gt;/**
 * Created by PhpStorm.
 * User: zzhpeng
 * Date: 2019/11/2
 * Time: 11:32 AM
 */&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Lock&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_instance&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;private&lt;/span&gt;   &lt;span class=&quot;nv&quot;&gt;$_redis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;__construct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;_redis&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\Redis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;_redis&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'127.0.0.1'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getInstance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_instance&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_instance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_instance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt;  &lt;span class=&quot;nx&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;sd&quot;&gt;/**
     * åŠ é”
     * @author: zzhpeng
     * Date: 2019/11/2
     * @param $key string é”åç§°
     * @param $expTTL int å¤šä¹…è¿‡æœŸï¼Œç§’å•ä½
     *
     * @return bool
     */&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$expTTL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//set å®ç°setnx å’Œ expire()çš„æ•ˆæœ&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$isLock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;_redis&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$expTTL&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'nx'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'ex'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$expTTL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$isLock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;  &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;sd&quot;&gt;/**
     * @param $key string è§£é”
     */&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;del&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;_redis&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;del&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;PDO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'mysql:host=127.0.0.1;dbname=store'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'root'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'123456789'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;//é”€å”®æ•°é‡&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_GET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;??&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//é”å&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$lockName&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'store_depot_batch_lock'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//åŠ é”&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$lock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getInstance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//åŠ é”å¤±è´¥æŠ›å‡ºç½‘ç»œå¼‚å¸¸é”™è¯¯&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$lockName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;RedisException&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'ç½‘ç»œå¼‚å¸¸,è¯·ç¨åå†è¯•'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//å¼€å¯äº‹åŠ¡&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;beginTransaction&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//æŸ¥è¯¢é—¨åº—ä»“åº“æ‰¹æ¬¡ä¿¡æ¯&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchSql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;select * from  `depot_store_depot_batch` where id =1 limit 1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//æ“ä½œåå†»ç»“æ•°é‡&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'frozen_num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$activeNumber&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$activeNumber&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'å•†å“å·²å”®ç½„äº†'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//ä¸‹å•ä¸»è¡¨&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$orderSql&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;insert into `order` VALUES (null,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,1,NOW(),NOW(),null)&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$orderSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$orderId&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lastInsertId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//ä¸‹å•æ˜¯å¦æˆåŠŸåˆ¤æ–­&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$orderId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'ä¸‹å•å¤±è´¥,è¯·ç¨åå†è¯•'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//æ›´æ–°ä»“åº“&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchUpdateSql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;update `depot_store_depot_batch` set `frozen_num`=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; WHERE id=1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchUpdateSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//å†»ç»“è®°å½•æ“ä½œsql&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$actionSql&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;insert into `depot_store_depot_batch_frozen_record` VALUES (null,1,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$depotStoreDepotBatchRes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'frozen_num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$afterFrozenNum&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$num&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;,'å¹¶å‘æµ‹è¯•',NOW(),NOW())&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$actionSql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//æäº¤äº‹åŠ¡&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;commit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;//è§£é”&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;del&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$lockName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'ä¸‹å•æˆåŠŸ,è®¢å•idä¸º'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$orderId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;\RedisException&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getMessage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;\Exception&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//å›æ»šäº‹åŠ¡&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;inTransaction&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()){&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$pdo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;rollBack&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
   &lt;span class=&quot;c1&quot;&gt;//è§£é”&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;del&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$lockName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getMessage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;abå‹åŠ›æµ‹è¯•ï¼Œab -n 1000 -c 100 http://127.0.0.1:83/redis.php&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; ~ ab -n 1000 -c 100 http://127.0.0.1:83/redis.php
This is ApacheBench, Version 2.3 &amp;lt;$Revision: 1826891 $&amp;gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking 127.0.0.1 (be patient)
Completed 100 requests
Completed 200 requests
Completed 300 requests
Completed 400 requests
Completed 500 requests
Completed 600 requests
Completed 700 requests
Completed 800 requests
Completed 900 requests
Completed 1000 requests
Finished 1000 requests


Server Software:        nginx/1.15.1
Server Hostname:        127.0.0.1
Server Port:            83

Document Path:          /redis.php
Document Length:        25 bytes

Concurrency Level:      100
Time taken for tests:   2.508 seconds
Complete requests:      1000
Failed requests:        991
   (Connect: 0, Receive: 0, Length: 991, Exceptions: 0)
Total transferred:      189001 bytes
HTML transferred:       27001 bytes
Requests per second:    398.65 [#/sec] (mean)
Time per request:       250.845 [ms] (mean)
Time per request:       2.508 [ms] (mean, across all concurrent requests)
Transfer rate:          73.58 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    0   0.8      0       4
Processing:    28  232  37.8    239     389
Waiting:       28  232  37.8    239     389
Total:         33  233  37.5    239     389

Percentage of the requests served within a certain time (ms)
  50%    239
  66%    248
  75%    254
  80%    258
  90%    269
  95%    284
  98%    312
  99%    320
 100%    389 (longest request)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æŸ¥çœ‹Orderè¡¨æƒ…å†µï¼Œæ˜¾ç¤ºäº†10row orderã€‚&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select * from `order`;
+----+-----+----------------------+---------------------+---------------------+-------------+
| id | num | store_depot_batch_id | create_time         | update_time         | delete_time |
+----+-----+----------------------+---------------------+---------------------+-------------+
|  1 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  2 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  3 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  4 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  5 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  6 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  7 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  8 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
|  9 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
| 10 |   1 |                    1 | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 | NULL        |
+----+-----+----------------------+---------------------+---------------------+-------------+
10 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æŸ¥çœ‹depot_store_depot_batchè¡¨æƒ…å†µï¼Œç¡®å®å†»ç»“äº†10ä¸ªã€‚&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select * from `depot_store_depot_batch`;
+----+-----+------------+---------------------+---------------------+-------------+
| id | num | frozen_num | create_time         | update_time         | delete_time |
+----+-----+------------+---------------------+---------------------+-------------+
|  1 |  10 |         10 | 2019-11-04 06:33:43 | 2019-11-04 06:33:43 | NULL        |
+----+-----+------------+---------------------+---------------------+-------------+
1 row in set (0.01 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æŸ¥çœ‹depot_store_depot_batch_frozen_recordè¡¨æƒ…å†µï¼Œ10rowè®°å½•ã€‚&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select * from depot_store_depot_batch_frozen_record;
+----+----------------------------+-------------------+------------------+------------+------+---------------------+---------------------+
| id | depot_store_depot_batch_id | before_frozen_num | after_frozen_num | frozen_num | desc | create_time         | update_time         |
+----+----------------------------+-------------------+------------------+------------+------+---------------------+---------------------+
|  1 |                          1 |                 0 |                1 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  2 |                          1 |                 1 |                2 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  3 |                          1 |                 2 |                3 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  4 |                          1 |                 3 |                4 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  5 |                          1 |                 4 |                5 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  6 |                          1 |                 5 |                6 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  7 |                          1 |                 6 |                7 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  8 |                          1 |                 7 |                8 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
|  9 |                          1 |                 8 |                9 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
| 10 |                          1 |                 9 |               10 |          1 | ???? | 2019-11-04 06:34:40 | 2019-11-04 06:34:40 |
+----+----------------------------+-------------------+------------------+------------+------+---------------------+---------------------+
10 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;ç»“è®ºå°±æ˜¯ï¼Œæˆ‘åŠ å¤§çš„å‹åŠ›æµ‹è¯•ï¼Œç»“æœä¹Ÿæ˜¯æˆ‘ä»¬æƒ³è¦çš„&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&quot;æ³¨æ„ä¸ç–‘æƒ‘&quot;&gt;æ³¨æ„ä¸ç–‘æƒ‘&lt;/h3&gt;
&lt;p&gt;æ³¨æ„ï¼š&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;1ã€è¦ç”¨å¤šè¿›ç¨‹çš„php-fpmæµ‹è¯•ï¼Œä¸èƒ½ç”¨å•è¿›ç¨‹çš„cliã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç–‘æƒ‘ï¼š&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;1ã€åœ¨redis set 10ç§’è¿‡æœŸåï¼Œç³Ÿç³•æƒ…å†µå°±æ˜¯ç¨‹åºè¿˜æ²¡æ‰§è¡Œå®Œæˆsetè¿‡æœŸäº†ï¼Œå¯¼è‡´è¶…å–ç°è±¡ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;å‚è€ƒ&quot;&gt;å‚è€ƒ&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;1ã€&lt;a href=&quot;https://www.jianshu.com/p/0eadec61e737&quot;&gt;åˆ©ç”¨Redisé”è§£å†³é«˜å¹¶å‘é—®é¢˜ - ç®€ä¹¦&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;2ã€&lt;a href=&quot;http://www.sohu.com/a/240877096_99896109&quot;&gt;æ¼«ç”»ï¼šä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”ï¼Ÿ&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

</description>
				<pubDate>Sat, 02 Nov 2019 00:00:00 +0800</pubDate>
				<link>/redis-set.html</link>
				<guid isPermaLink="true">/redis-set.html</guid>
			</item>
		
			<item>
				<title>Mysqlä½¿ç”¨INåŠŸèƒ½ç›¸å…³ä¸æ€§èƒ½å¯¹æ¯”</title>
				<description>&lt;h3 id=&quot;é—®é¢˜æ¦‚è¿°&quot;&gt;é—®é¢˜æ¦‚è¿°&lt;/h3&gt;
&lt;p&gt;å¹³æ—¶Mysqlå–œæ¬¢å…ˆsqlè¯­å¥æ‰¾å‡ºidå­—ç¬¦ä¸²ï¼Œç„¶åç”¨inåé¢æ¥ï¼ˆidï¼Œidï¼Œâ€¦â€¦ï¼‰å»æŸ¥æ‰¾æ•°æ®ã€‚æŸ¥é˜…ç›¸å…³æ–‡ç« ï¼Œè¯´sqlè¯­å¥é•¿åº¦æœ‰é™åˆ¶ï¼Œéšç€æ•°æ®å¢é•¿å°±ä¸èƒ½æ‰§è¡Œï¼Œä½†æ˜¯
è¿™ä¸ªé•¿åº¦å´å¾ˆå¤§ï¼Œä¸€èˆ¬å¯ä»¥ä¸ç”¨è€ƒè™‘ã€‚&lt;/p&gt;

&lt;p&gt;æŸ¥çœ‹æ–¹æ³•ã€‚&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt;show variables like '%max_allowed_pack%'
+--------------------------+-----------------+
| Variable_name            | Value           |
+--------------------------+-----------------+
| max_allowed_packet       | 1073741824      |
| slave_max_allowed_packet | 1073741824      |
+--------------------------+-----------------+
è¿”å›è¡Œæ•°ï¼š[2]ï¼Œè€—æ—¶ï¼š7 ms.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;æ ¹æ®è¿”å›ç»“æœå¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªæœ€å¤§é•¿åº¦æ˜¯å¾ˆå¤§çš„ã€‚&lt;/p&gt;

&lt;h3 id=&quot;inç›¸å…³æ“ä½œå’Œæ›¿ä»£æ–¹æ³•å¯¹æ¯”&quot;&gt;INç›¸å…³æ“ä½œå’Œæ›¿ä»£æ–¹æ³•å¯¹æ¯”&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;1ã€INåé¢æ¥ä¸»é”®å­—ç¬¦ä¸²ï¼ˆ æ¦‚å¿µé”™è¯¯SELECT GROUP_CONCAT(order_id,â€™â€™) FROM order_action WHERE NAME = â€˜user_addâ€™ æŸ¥æ‰¾å‡ºæ¥çš„å¹¶ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯æ•°æ®é›† ï¼‰&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä»£ç &lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;EXPLAIN SELECT
	* 
FROM
	`order` 
WHERE
	id IN ( SELECT GROUP_CONCAT(order_id,'') FROM order_action WHERE NAME = 'user_add' )
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ç»“æœæ˜¾ç¤ºï¼Œorderè¡¨éœ€è¦æ‰¾å…¨éƒ¨è¡Œï¼Œorder_actionä¹Ÿæ˜¯ã€‚&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;+----+--------------------+--------------+------------+------+---------------+------+---------+------+-------+----------+-------------+
| id | select_type        | table        | partitions | type | possible_keys | key  | key_len | ref  | rows  | filtered | Extra       |
+----+--------------------+--------------+------------+------+---------------+------+---------+------+-------+----------+-------------+
|  1 | PRIMARY            | order        | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 17239 |   100.00 | Using where |
|  2 | DEPENDENT SUBQUERY | order_action | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 20660 |    10.00 | Using where |
+----+--------------------+--------------+------------+------+---------------+------+---------+------+-------+----------+-------------+
2 rows in set, 1 warning (0.01 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;2ã€in åé¢æ¥ select æ•°æ®é›†&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä»£ç &lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;EXPLAIN SELECT
	* 
FROM
	`order` 
WHERE
	id IN ( SELECT order_id FROM order_action WHERE NAME = 'user_add' )
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ç»“æœæ˜¾ç¤ºï¼Œä¼šåˆ›å»ºä¸´æ—¶è¡¨&lt;subquery2&gt;ï¼Œorderè¡¨åªéœ€è¦æŸ¥1rowsï¼Œorder_actionè¡¨æŸ¥æ‰€æœ‰è¡Œã€‚&lt;/subquery2&gt;&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;+----+--------------+--------------+------------+--------+---------------+---------+---------+----------------------+-------+----------+-------------+
| id | select_type  | table        | partitions | type   | possible_keys | key     | key_len | ref                  | rows  | filtered | Extra       |
+----+--------------+--------------+------------+--------+---------------+---------+---------+----------------------+-------+----------+-------------+
|  1 | SIMPLE       | &amp;lt;subquery2&amp;gt;  | NULL       | ALL    | NULL          | NULL    | NULL    | NULL                 |  NULL |   100.00 | NULL        |
|  1 | SIMPLE       | order        | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | &amp;lt;subquery2&amp;gt;.order_id |     1 |   100.00 | NULL        |
|  2 | MATERIALIZED | order_action | NULL       | ALL    | NULL          | NULL    | NULL    | NULL                 | 20649 |    10.00 | Using where |
+----+--------------+--------------+------------+--------+---------------+---------+---------+----------------------+-------+----------+-------------+
3 rows in set, 1 warning (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;3ã€ç”¨ join æ›¿æ¢ in&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä»£ç &lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;EXPLAIN SELECT
	* 
FROM
	`order` AS ot
	INNER JOIN order_action oat ON oat.order_id = ot.id 
	AND oat.NAME = 'user_add'
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ç»“æœæ˜¾ç¤ºï¼Œä¸åˆ›å»ºä¸´æ—¶è¡¨ï¼Œä½†orderè¡¨åªéœ€è¦æŸ¥1rowsï¼Œorder_actionè¡¨æŸ¥æ‰€æœ‰è¡Œã€‚&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;+----+-------------+-------+------------+--------+---------------+---------+---------+-------------------+-------+----------+-------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref               | rows  | filtered | Extra       |
+----+-------------+-------+------------+--------+---------------+---------+---------+-------------------+-------+----------+-------------+
|  1 | SIMPLE      | oat   | NULL       | ALL    | NULL          | NULL    | NULL    | NULL              | 20653 |    10.00 | Using where |
|  1 | SIMPLE      | ot    | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | sima.oat.order_id |     1 |   100.00 | NULL        |
+----+-------------+-------+------------+--------+---------------+---------+---------+-------------------+-------+----------+-------------+
2 rows in set, 1 warning (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;4ã€exist æ›¿ä»£ in ï¼ˆæ•ˆç‡ä¸è¡Œï¼‰&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä»£ç &lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;EXPLAIN SELECT
	* 
FROM
	`order` AS ot 
WHERE
	EXISTS ( SELECT order_id FROM order_action oat WHERE ot.id = oat.order_id AND NAME = 'user_add' ) 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ç»“æœæµ‹è¯•çš„æ˜¯ä¸¤å¼ å…³è”çš„è¡¨éƒ½æŸ¥äº†æ‰€æœ‰ã€‚æ‰€ä»¥existæ•ˆç‡ä¸è¡Œã€‚&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;+----+--------------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+
| id | select_type        | table | partitions | type | possible_keys | key  | key_len | ref  | rows  | filtered | Extra       |
+----+--------------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+
|  1 | PRIMARY            | ot    | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 17233 |   100.00 | Using where |
|  2 | DEPENDENT SUBQUERY | oat   | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 20656 |     1.00 | Using where |
+----+--------------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+
2 rows in set, 2 warnings (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;explain-åˆ†æ-sql-è¯­å¥çš„ç›¸å…³å±æ€§è§£æ&quot;&gt;explain åˆ†æ sql è¯­å¥çš„ç›¸å…³å±æ€§è§£æ&lt;/h3&gt;

&lt;p&gt;è¿æ¥æ“ä½œçš„TYPEç±»å‹&lt;/p&gt;

&lt;p&gt;ï¼ˆ1ï¼‰SYSTEM&lt;/p&gt;

&lt;p&gt;CONSTçš„ç‰¹ä¾‹ï¼Œå½“è¡¨ä¸Šåªæœ‰ä¸€æ¡å…ƒç»„åŒ¹é…&lt;/p&gt;

&lt;p&gt;ï¼ˆ2ï¼‰CONST&lt;/p&gt;

&lt;p&gt;WHEREæ¡ä»¶ç­›é€‰åè¡¨ä¸Šè‡³å¤šæœ‰ä¸€æ¡å…ƒç»„åŒ¹é…æ—¶ï¼Œæ¯”å¦‚WHERE ID = 2 ï¼ˆIDæ˜¯ä¸»é”®ï¼Œå€¼ä¸º2çš„è¦ä¹ˆæœ‰ä¸€æ¡è¦ä¹ˆæ²¡æœ‰ï¼‰&lt;/p&gt;

&lt;p&gt;ï¼ˆ3ï¼‰EQ_REF&lt;/p&gt;

&lt;p&gt;å‚ä¸è¿æ¥è¿ç®—çš„è¡¨æ˜¯å†…è¡¨ï¼ˆåœ¨ä»£ç å®ç°çš„ç®—æ³•ä¸­ï¼Œä¸¤è¡¨è¿æ¥æ—¶ä½œä¸ºå¾ªç¯ä¸­çš„å†…å¾ªç¯éå†çš„å¯¹è±¡ï¼Œè¿™æ ·çš„è¡¨ç§°ä¸ºå†…è¡¨ï¼‰ã€‚
åŸºäºç´¢å¼•ï¼ˆè¿æ¥å­—æ®µä¸Šå­˜åœ¨å”¯ä¸€ç´¢å¼•æˆ–è€…ä¸»é”®ç´¢å¼•ï¼Œä¸”æ“ä½œç¬¦å¿…é¡»æ˜¯â€œ=â€è°“è¯ï¼Œç´¢å¼•å€¼ä¸èƒ½ä¸ºNULLï¼‰åšæ‰«æï¼Œä½¿å¾—å¯¹å¤–è¡¨çš„ä¸€æ¡å…ƒç»„ï¼Œå†…è¡¨åªæœ‰å”¯ä¸€ä¸€æ¡å…ƒç»„ä¸ä¹‹å¯¹åº”ã€‚&lt;/p&gt;

&lt;p&gt;ï¼ˆ4ï¼‰REF&lt;/p&gt;

&lt;p&gt;å¯ä»¥ç”¨äºå•è¡¨æ‰«ææˆ–è€…è¿æ¥ã€‚å‚ä¸è¿æ¥è¿ç®—çš„è¡¨ï¼Œæ˜¯å†…è¡¨ã€‚
åŸºäºç´¢å¼•ï¼ˆè¿æ¥å­—æ®µä¸Šçš„ç´¢å¼•æ˜¯éå”¯ä¸€ç´¢å¼•ï¼Œæ“ä½œç¬¦å¿…é¡»æ˜¯â€œ=â€è°“è¯ï¼Œè¿æ¥å­—æ®µå€¼ä¸å¯ä¸ºNULLï¼‰åšæ‰«æï¼Œä½¿å¾—å¯¹å¤–è¡¨çš„ä¸€æ¡å…ƒç»„ï¼Œå†…è¡¨å¯æœ‰è‹¥å¹²æ¡å…ƒç»„ä¸ä¹‹å¯¹åº”ã€‚&lt;/p&gt;

&lt;p&gt;ï¼ˆ5ï¼‰REF_OR_NULL&lt;/p&gt;

&lt;p&gt;ç±»ä¼¼REFï¼Œåªæ˜¯æœç´¢æ¡ä»¶åŒ…æ‹¬ï¼šè¿æ¥å­—æ®µçš„å€¼å¯ä»¥ä¸ºNULLçš„æƒ…å†µï¼Œæ¯”å¦‚ where col = 2 or col is null&lt;/p&gt;

&lt;p&gt;ï¼ˆ6ï¼‰RANGE&lt;/p&gt;

&lt;p&gt;èŒƒå›´æ‰«æï¼ŒåŸºäºç´¢å¼•åšèŒƒå›´æ‰«æï¼Œä¸ºè¯¸å¦‚BETWEENï¼ŒINï¼Œ&amp;gt;=ï¼ŒLIKEç±»æ“ä½œæä¾›æ”¯æŒ&lt;/p&gt;

&lt;p&gt;ï¼ˆ7ï¼‰INDEX_SCAN&lt;/p&gt;

&lt;p&gt;ç´¢å¼•åšæ‰«æï¼Œæ˜¯åŸºäºç´¢å¼•åœ¨ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸Šæ‰¾æ»¡è¶³æ¡ä»¶çš„æ•°æ®ï¼ˆä¸éœ€è¦è®¿é—®æ•°æ®æ–‡ä»¶ï¼‰&lt;/p&gt;

&lt;p&gt;ï¼ˆ8ï¼‰ALL&lt;/p&gt;

&lt;p&gt;å…¨è¡¨æ‰«ææˆ–è€…èŒƒå›´æ‰«æï¼šä¸ä½¿ç”¨ç´¢å¼•ï¼Œé¡ºåºæ‰«æï¼Œç›´æ¥è¯»å–è¡¨ä¸Šçš„æ•°æ®ï¼ˆè®¿é—®æ•°æ®æ–‡ä»¶ï¼‰&lt;/p&gt;

&lt;p&gt;ï¼ˆ9ï¼‰UNIQUE_SUBQUERY&lt;/p&gt;

&lt;p&gt;åœ¨å­æŸ¥è¯¢ä¸­ï¼ŒåŸºäºå”¯ä¸€ç´¢å¼•è¿›è¡Œæ‰«æï¼Œç±»ä¼¼äºEQ_REF&lt;/p&gt;

&lt;p&gt;ï¼ˆ10ï¼‰INDEX_SUBQUERY&lt;/p&gt;

&lt;p&gt;åœ¨å­æŸ¥è¯¢ä¸­ï¼ŒåŸºäºé™¤å”¯ä¸€ç´¢å¼•ä¹‹å¤–çš„ç´¢å¼•è¿›è¡Œæ‰«æ&lt;/p&gt;

&lt;p&gt;ï¼ˆ11ï¼‰INDEX_MERGE&lt;/p&gt;

&lt;p&gt;å¤šé‡èŒƒå›´æ‰«æã€‚ä¸¤è¡¨è¿æ¥çš„æ¯ä¸ªè¡¨çš„è¿æ¥å­—æ®µä¸Šå‡æœ‰ç´¢å¼•å­˜åœ¨ä¸”ç´¢å¼•æœ‰åºï¼Œç»“æœåˆå¹¶åœ¨ä¸€èµ·ã€‚é€‚ç”¨äºä½œé›†åˆçš„å¹¶ã€äº¤æ“ä½œã€‚&lt;/p&gt;

&lt;p&gt;ï¼ˆ12ï¼‰FT&lt;/p&gt;

&lt;p&gt;FULL TEXTï¼Œå…¨æ–‡æ£€ç´¢&lt;/p&gt;

&lt;h3 id=&quot;ç»“è®º&quot;&gt;ç»“è®º&lt;/h3&gt;

&lt;p&gt;å®é™…æµ‹è¯•æ˜¾ç¤ºï¼Œinæ•°æ®é›†æ˜¯æœ€å¿«çš„ã€‚æ‰€æœ‰ä¼˜å…ˆè€ƒè™‘inæ•°æ®é›†è¿™ç§ä¼šåˆ›å»ºä¸´æ—¶è¡¨çš„æ–¹å¼ã€‚&lt;/p&gt;

&lt;h3 id=&quot;å‚è€ƒ&quot;&gt;å‚è€ƒ&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;1ã€&lt;a href=&quot;https://blog.csdn.net/seelye/article/details/46453651&quot;&gt;mysql explain çš„typeè§£é‡Š&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;2ã€&lt;a href=&quot;https://blog.csdn.net/fukaiit/article/details/83515439&quot;&gt;MySqlä¸­inæŸ¥è¯¢æ•ˆç‡ä½çš„æ›¿ä»£æ–¹æ³•&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

</description>
				<pubDate>Mon, 07 Oct 2019 00:00:00 +0800</pubDate>
				<link>/mysql-in.html</link>
				<guid isPermaLink="true">/mysql-in.html</guid>
			</item>
		
	</channel>
</rss>
